# 平台交互

Flutter 应用需要与原生平台（Android/iOS）进行交互，访问设备功能如相机、位置、通知等。本章介绍 Flutter 的平台交互方式。

## Platform Channels（平台通道）

Platform Channels 是 Flutter 与原生代码通信的桥梁，类似于 React Native 的 Native Modules。

### 基本概念

```dart
// Flutter 端调用原生方法
import 'package:flutter/services.dart';

// 创建 MethodChannel（类似于 React Native 的 NativeModules）
static const platform = MethodChannel('com.example.app/channel');

// 调用原生方法
Future<String> getNativeData() async {
  try {
    final String result = await platform.invokeMethod('getData');
    return result;
  } on PlatformException catch (e) {
    print('Error: ${e.message}');
    return 'Error';
  }
}

// 调用原生方法并传递参数
Future<void> setNativeData(String data) async {
  try {
    await platform.invokeMethod('setData', {'key': 'value', 'data': data});
  } on PlatformException catch (e) {
    print('Error: ${e.message}');
  }
}

// 与 React Native 对比
// React Native:
//   import { NativeModules } from 'react-native';
//   NativeModules.MyModule.getData().then(result => ...);
// Flutter:
//   await platform.invokeMethod('getData')
```

### Android 端实现

```kotlin
// MainActivity.kt
import android.os.Bundle
import io.flutter.embedding.android.FlutterActivity
import io.flutter.embedding.engine.FlutterEngine
import io.flutter.plugin.common.MethodChannel

class MainActivity: FlutterActivity() {
    private val CHANNEL = "com.example.app/channel"
    
    override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
        super.configureFlutterEngine(flutterEngine)
        
        MethodChannel(flutterEngine.dartExecutor.binaryMessenger, CHANNEL)
            .setMethodCallHandler { call, result ->
                when (call.method) {
                    "getData" -> {
                        val data = getDataFromNative()
                        result.success(data)
                    }
                    "setData" -> {
                        val key = call.argument<String>("key")
                        val data = call.argument<String>("data")
                        setDataToNative(key, data)
                        result.success(null)
                    }
                    else -> {
                        result.notImplemented()
                    }
                }
            }
    }
    
    private fun getDataFromNative(): String {
        return "Data from Android"
    }
    
    private fun setDataToNative(key: String?, data: String?) {
        // 处理数据
    }
}
```

### iOS 端实现

```swift
// AppDelegate.swift
import Flutter
import UIKit

@UIApplicationMain
@objc class AppDelegate: FlutterAppDelegate {
    override func application(
        _ application: UIApplication,
        didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
    ) -> Bool {
        let controller = window?.rootViewController as! FlutterViewController
        let channel = FlutterMethodChannel(
            name: "com.example.app/channel",
            binaryMessenger: controller.binaryMessenger
        )
        
        channel.setMethodCallHandler { (call: FlutterMethodCall, result: @escaping FlutterResult) in
            switch call.method {
            case "getData":
                let data = self.getDataFromNative()
                result(data)
            case "setData":
                let args = call.arguments as! Dictionary<String, Any>
                let key = args["key"] as! String
                let data = args["data"] as! String
                self.setDataToNative(key: key, data: data)
                result(nil)
            default:
                result(FlutterMethodNotImplemented)
            }
        }
        
        return super.application(application, didFinishLaunchingWithOptions: launchOptions)
    }
    
    private func getDataFromNative() -> String {
        return "Data from iOS"
    }
    
    private func setDataToNative(key: String, data: String) {
        // 处理数据
    }
}
```

## 常用平台插件

### 相机（camera）

```yaml
# pubspec.yaml
dependencies:
  camera: ^0.10.5+5
```

```dart
import 'package:camera/camera.dart';

class CameraExample extends StatefulWidget {
  @override
  State<CameraExample> createState() => _CameraExampleState();
}

class _CameraExampleState extends State<CameraExample> {
  CameraController? _controller;
  List<CameraDescription>? _cameras;
  
  @override
  void initState() {
    super.initState();
    _initializeCamera();
  }
  
  Future<void> _initializeCamera() async {
    _cameras = await availableCameras();
    if (_cameras!.isNotEmpty) {
      _controller = CameraController(
        _cameras![0],
        ResolutionPreset.high,
      );
      await _controller!.initialize();
      setState(() {});
    }
  }
  
  Future<void> _takePicture() async {
    if (!_controller!.value.isInitialized) return;
    
    final image = await _controller!.takePicture();
    // 处理图片
    print('Picture taken: ${image.path}');
  }
  
  @override
  void dispose() {
    _controller?.dispose();
    super.dispose();
  }
  
  @override
  Widget build(BuildContext context) {
    if (_controller == null || !_controller!.value.isInitialized) {
      return Center(child: CircularProgressIndicator());
    }
    
    return Scaffold(
      body: CameraPreview(_controller!),
      floatingActionButton: FloatingActionButton(
        onPressed: _takePicture,
        child: Icon(Icons.camera),
      ),
    );
  }
}
```

### 位置服务（geolocator）

```yaml
# pubspec.yaml
dependencies:
  geolocator: ^10.1.0
```

```dart
import 'package:geolocator/geolocator.dart';

class LocationExample extends StatefulWidget {
  @override
  State<LocationExample> createState() => _LocationExampleState();
}

class _LocationExampleState extends State<LocationExample> {
  Position? _position;
  
  Future<void> _getCurrentLocation() async {
    // 检查权限
    bool serviceEnabled = await Geolocator.isLocationServiceEnabled();
    if (!serviceEnabled) {
      print('Location services are disabled');
      return;
    }
    
    LocationPermission permission = await Geolocator.checkPermission();
    if (permission == LocationPermission.denied) {
      permission = await Geolocator.requestPermission();
      if (permission == LocationPermission.denied) {
        print('Location permissions are denied');
        return;
      }
    }
    
    if (permission == LocationPermission.deniedForever) {
      print('Location permissions are permanently denied');
      return;
    }
    
    // 获取位置
    Position position = await Geolocator.getCurrentPosition(
      desiredAccuracy: LocationAccuracy.high,
    );
    
    setState(() {
      _position = position;
    });
    
    print('Latitude: ${position.latitude}, Longitude: ${position.longitude}');
  }
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Location')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            if (_position != null)
              Text('Latitude: ${_position!.latitude}'),
            if (_position != null)
              Text('Longitude: ${_position!.longitude}'),
            ElevatedButton(
              onPressed: _getCurrentLocation,
              child: Text('Get Location'),
            ),
          ],
        ),
      ),
    );
  }
}
```

### 通知（flutter_local_notifications）

```yaml
# pubspec.yaml
dependencies:
  flutter_local_notifications: ^16.3.0
```

```dart
import 'package:flutter_local_notifications/flutter_local_notifications.dart';

class NotificationService {
  static final FlutterLocalNotificationsPlugin _notifications =
      FlutterLocalNotificationsPlugin();
  
  static Future<void> initialize() async {
    // Android 初始化
    const AndroidInitializationSettings androidSettings =
        AndroidInitializationSettings('@mipmap/ic_launcher');
    
    // iOS 初始化
    const DarwinInitializationSettings iosSettings =
        DarwinInitializationSettings(
      requestAlertPermission: true,
      requestBadgePermission: true,
      requestSoundPermission: true,
    );
    
    const InitializationSettings settings = InitializationSettings(
      android: androidSettings,
      iOS: iosSettings,
    );
    
    await _notifications.initialize(settings);
  }
  
  // 显示通知
  static Future<void> showNotification({
    required int id,
    required String title,
    required String body,
  }) async {
    const AndroidNotificationDetails androidDetails =
        AndroidNotificationDetails(
      'channel_id',
      'channel_name',
      importance: Importance.high,
      priority: Priority.high,
    );
    
    const NotificationDetails details = NotificationDetails(
      android: androidDetails,
    );
    
    await _notifications.show(id, title, body, details);
  }
  
  // 定时通知
  static Future<void> scheduleNotification({
    required int id,
    required String title,
    required String body,
    required DateTime scheduledDate,
  }) async {
    const AndroidNotificationDetails androidDetails =
        AndroidNotificationDetails(
      'channel_id',
      'channel_name',
      importance: Importance.high,
      priority: Priority.high,
    );
    
    const NotificationDetails details = NotificationDetails(
      android: androidDetails,
    );
    
    await _notifications.schedule(
      id,
      title,
      body,
      scheduledDate,
      details,
    );
  }
}

// 使用
await NotificationService.initialize();
await NotificationService.showNotification(
  id: 1,
  title: 'Hello',
  body: 'This is a notification',
);
```

### 文件选择器（file_picker）

```yaml
# pubspec.yaml
dependencies:
  file_picker: ^6.1.1
```

```dart
import 'package:file_picker/file_picker.dart';

Future<void> pickFile() async {
  FilePickerResult? result = await FilePicker.platform.pickFiles();
  
  if (result != null) {
    PlatformFile file = result.files.first;
    print('File name: ${file.name}');
    print('File size: ${file.size}');
    print('File path: ${file.path}');
  }
}

// 选择多个文件
Future<void> pickMultipleFiles() async {
  FilePickerResult? result = await FilePicker.platform.pickFiles(
    allowMultiple: true,
  );
  
  if (result != null) {
    for (var file in result.files) {
      print('File: ${file.name}');
    }
  }
}

// 选择特定类型文件
Future<void> pickImage() async {
  FilePickerResult? result = await FilePicker.platform.pickFiles(
    type: FileType.image,
  );
}
```

### 分享（share_plus）

```yaml
# pubspec.yaml
dependencies:
  share_plus: ^7.2.1
```

```dart
import 'package:share_plus/share_plus.dart';

Future<void> shareText(String text) async {
  await Share.share(text);
}

Future<void> shareFile(String filePath) async {
  await Share.shareXFiles([XFile(filePath)]);
}
```

## 权限管理

### permission_handler

```yaml
# pubspec.yaml
dependencies:
  permission_handler: ^11.1.0
```

```dart
import 'package:permission_handler/permission_handler.dart';

// 请求权限
Future<void> requestPermission() async {
  // 相机权限
  var status = await Permission.camera.request();
  if (status.isGranted) {
    print('Camera permission granted');
  } else if (status.isDenied) {
    print('Camera permission denied');
  } else if (status.isPermanentlyDenied) {
    // 打开设置页面
    await openAppSettings();
  }
  
  // 位置权限
  status = await Permission.location.request();
  
  // 存储权限
  status = await Permission.storage.request();
  
  // 检查权限状态
  if (await Permission.camera.isGranted) {
    print('Camera is granted');
  }
}

// 请求多个权限
Future<void> requestMultiplePermissions() async {
  Map<Permission, PermissionStatus> statuses = await [
    Permission.camera,
    Permission.location,
    Permission.storage,
  ].request();
  
  print('Camera: ${statuses[Permission.camera]}');
  print('Location: ${statuses[Permission.location]}');
  print('Storage: ${statuses[Permission.storage]}');
}
```

## 平台信息

### 获取平台信息

```dart
import 'dart:io';

// 检查平台
if (Platform.isAndroid) {
  print('Running on Android');
} else if (Platform.isIOS) {
  print('Running on iOS');
}

// 获取平台版本
import 'package:device_info_plus/device_info_plus.dart';

Future<void> getDeviceInfo() async {
  DeviceInfoPlugin deviceInfo = DeviceInfoPlugin();
  
  if (Platform.isAndroid) {
    AndroidDeviceInfo androidInfo = await deviceInfo.androidInfo;
    print('Android Version: ${androidInfo.version.release}');
    print('Device: ${androidInfo.model}');
  } else if (Platform.isIOS) {
    IosDeviceInfo iosInfo = await deviceInfo.iosInfo;
    print('iOS Version: ${iosInfo.systemVersion}');
    print('Device: ${iosInfo.model}');
  }
}
```

## 实际应用示例

### 完整的平台交互服务

```dart
class PlatformService {
  static const platform = MethodChannel('com.example.app/service');
  
  // 获取设备信息
  static Future<Map<String, dynamic>> getDeviceInfo() async {
    try {
      final result = await platform.invokeMethod('getDeviceInfo');
      return Map<String, dynamic>.from(result);
    } on PlatformException catch (e) {
      print('Error: ${e.message}');
      return {};
    }
  }
  
  // 打开设置
  static Future<void> openSettings() async {
    try {
      await platform.invokeMethod('openSettings');
    } on PlatformException catch (e) {
      print('Error: ${e.message}');
    }
  }
  
  // 振动
  static Future<void> vibrate(int duration) async {
    try {
      await platform.invokeMethod('vibrate', {'duration': duration});
    } on PlatformException catch (e) {
      print('Error: ${e.message}');
    }
  }
}
```

## 总结

- ✅ 使用 `Platform Channels` 与原生代码通信
- ✅ 使用现有插件访问设备功能（相机、位置、通知等）
- ✅ 使用 `permission_handler` 管理权限
- ✅ 根据平台特性实现不同逻辑
- ✅ Flutter 插件生态丰富，大多数功能都有现成插件

下一步学习：[性能优化](./11-性能优化.md)

