# 测试

Flutter 提供了完善的测试框架，支持单元测试、Widget 测试和集成测试。本章介绍 Flutter 的测试方式。

## 测试类型

### 单元测试（Unit Test）

单元测试测试单个函数、方法或类，类似于 JavaScript 的 Jest 单元测试。

```dart
// 测试文件：test/calculator_test.dart
import 'package:flutter_test/flutter_test.dart';

// 被测试的类
class Calculator {
  int add(int a, int b) => a + b;
  int subtract(int a, int b) => a - b;
  int multiply(int a, int b) => a * b;
  double divide(int a, int b) {
    if (b == 0) throw ArgumentError('Cannot divide by zero');
    return a / b;
  }
}

void main() {
  group('Calculator', () {
    late Calculator calculator;
    
    setUp(() {
      // 每个测试前执行
      calculator = Calculator();
    });
    
    test('add should return sum of two numbers', () {
      // 测试加法
      expect(calculator.add(2, 3), 5);
      expect(calculator.add(-1, 1), 0);
    });
    
    test('subtract should return difference of two numbers', () {
      // 测试减法
      expect(calculator.subtract(5, 3), 2);
    });
    
    test('multiply should return product of two numbers', () {
      // 测试乘法
      expect(calculator.multiply(2, 3), 6);
    });
    
    test('divide should return quotient of two numbers', () {
      // 测试除法
      expect(calculator.divide(6, 2), 3.0);
    });
    
    test('divide should throw error when dividing by zero', () {
      // 测试异常
      expect(
        () => calculator.divide(5, 0),
        throwsArgumentError,
      );
    });
  });
}

// 运行测试
// flutter test

// 与 Jest 对比
// JavaScript:
//   describe('Calculator', () => {
//     test('add should return sum', () => {
//       expect(calculator.add(2, 3)).toBe(5);
//     });
//   });
// Flutter:
//   group('Calculator', () {
//     test('add should return sum', () {
//       expect(calculator.add(2, 3), 5);
//     });
//   });
```

### Widget 测试（Widget Test）

Widget 测试测试单个 Widget 的行为，类似于 React Testing Library。

```dart
// 测试文件：test/widget_test.dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';

// 被测试的 Widget
class Counter extends StatefulWidget {
  @override
  State<Counter> createState() => _CounterState();
}

class _CounterState extends State<Counter> {
  int _count = 0;
  
  void _increment() {
    setState(() {
      _count++;
    });
  }
  
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Text('Count: $_count'),
        ElevatedButton(
          onPressed: _increment,
          child: Text('Increment'),
        ),
      ],
    );
  }
}

void main() {
  testWidgets('Counter increments when button is pressed', (WidgetTester tester) async {
    // 构建 Widget
    await tester.pumpWidget(MaterialApp(home: Counter()));
    
    // 查找 Widget
    expect(find.text('Count: 0'), findsOneWidget);
    expect(find.text('Increment'), findsOneWidget);
    
    // 点击按钮
    await tester.tap(find.text('Increment'));
    await tester.pump();  // 触发重建
    
    // 验证结果
    expect(find.text('Count: 1'), findsOneWidget);
    expect(find.text('Count: 0'), findsNothing);
  });
  
  testWidgets('Counter displays correct count', (WidgetTester tester) async {
    await tester.pumpWidget(MaterialApp(home: Counter()));
    
    // 多次点击
    for (int i = 0; i < 5; i++) {
      await tester.tap(find.text('Increment'));
      await tester.pump();
    }
    
    expect(find.text('Count: 5'), findsOneWidget);
  });
}

// 与 React Testing Library 对比
// React:
//   render(<Counter />);
//   fireEvent.click(screen.getByText('Increment'));
//   expect(screen.getByText('Count: 1')).toBeInTheDocument();
// Flutter:
//   await tester.pumpWidget(Counter());
//   await tester.tap(find.text('Increment'));
//   expect(find.text('Count: 1'), findsOneWidget);
```

### 集成测试（Integration Test）

集成测试测试完整的应用流程，类似于端到端测试。

```dart
// 测试文件：integration_test/app_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';
import 'package:my_app/main.dart' as app;

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();
  
  testWidgets('Complete user flow', (WidgetTester tester) async {
    // 启动应用
    app.main();
    await tester.pumpAndSettle();
    
    // 执行操作
    await tester.tap(find.text('Login'));
    await tester.pumpAndSettle();
    
    await tester.enterText(find.byType(TextField).first, 'username');
    await tester.enterText(find.byType(TextField).last, 'password');
    await tester.pumpAndSettle();
    
    await tester.tap(find.text('Submit'));
    await tester.pumpAndSettle();
    
    // 验证结果
    expect(find.text('Welcome'), findsOneWidget);
  });
}

// 运行集成测试
// flutter test integration_test/app_test.dart
```

## 常用测试工具

### find（查找 Widget）

```dart
// 按文本查找
find.text('Hello')
find.textContaining('Hello')

// 按类型查找
find.byType(Text)
find.byType(ElevatedButton)

// 按 Key 查找
find.byKey(Key('my_key'))

// 按图标查找
find.byIcon(Icons.star)

// 查找多个
find.text('Hello')  // 查找一个
find.text('Hello', skipOffstage: false)  // 包括隐藏的
```

### tester（测试操作）

```dart
// 构建 Widget
await tester.pumpWidget(MyWidget());

// 等待动画完成
await tester.pumpAndSettle();

// 点击
await tester.tap(find.text('Button'));

// 长按
await tester.longPress(find.text('Button'));

// 输入文本
await tester.enterText(find.byType(TextField), 'Hello');

// 滑动
await tester.drag(find.byType(ListView), Offset(0, -100));

// 获取 Widget
final widget = tester.widget<Text>(find.text('Hello'));

// 获取状态
final state = tester.state<_CounterState>(find.byType(Counter));
```

### expect（断言）

```dart
// 基本断言
expect(actual, matcher);

// 常用匹配器
expect(value, equals(5));
expect(value, isTrue);
expect(value, isFalse);
expect(value, isNull);
expect(value, isNotNull);
expect(value, isA<String>());
expect(value, contains('hello'));
expect(value, startsWith('hello'));
expect(value, endsWith('world'));

// Widget 匹配器
expect(find.text('Hello'), findsOneWidget);
expect(find.text('Hello'), findsNothing);
expect(find.text('Hello'), findsWidgets);
expect(find.text('Hello'), findsNWidgets(2));
```

## Mock 和 Stub

### Mockito

```yaml
# pubspec.yaml
dev_dependencies:
  mockito: ^5.4.4
  build_runner: ^2.4.7
```

```dart
import 'package:mockito/mockito.dart';
import 'package:mockito/annotations.dart';

// 生成 Mock 类
@GenerateMocks([ApiService])
void main() {}

// 使用 Mock
class MockApiService extends Mock implements ApiService {}

void main() {
  test('should fetch data from API', () async {
    final mockApi = MockApiService();
    
    // 设置返回值
    when(mockApi.getData()).thenAnswer((_) async => 'Mock Data');
    
    // 执行测试
    final result = await mockApi.getData();
    
    // 验证调用
    verify(mockApi.getData()).called(1);
    expect(result, 'Mock Data');
  });
}

// 运行代码生成
// flutter pub run build_runner build
```

## 实际测试示例

### 测试表单验证

```dart
class LoginForm extends StatefulWidget {
  @override
  State<LoginForm> createState() => _LoginFormState();
}

class _LoginFormState extends State<LoginForm> {
  final _formKey = GlobalKey<FormState>();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  
  String? _validateEmail(String? value) {
    if (value == null || value.isEmpty) {
      return 'Email is required';
    }
    if (!value.contains('@')) {
      return 'Invalid email';
    }
    return null;
  }
  
  String? _validatePassword(String? value) {
    if (value == null || value.isEmpty) {
      return 'Password is required';
    }
    if (value.length < 6) {
      return 'Password must be at least 6 characters';
    }
    return null;
  }
  
  @override
  Widget build(BuildContext context) {
    return Form(
      key: _formKey,
      child: Column(
        children: [
          TextFormField(
            controller: _emailController,
            validator: _validateEmail,
            decoration: InputDecoration(labelText: 'Email'),
          ),
          TextFormField(
            controller: _passwordController,
            validator: _validatePassword,
            obscureText: true,
            decoration: InputDecoration(labelText: 'Password'),
          ),
          ElevatedButton(
            onPressed: () {
              if (_formKey.currentState!.validate()) {
                // 提交表单
              }
            },
            child: Text('Login'),
          ),
        ],
      ),
    );
  }
}

// 测试
void main() {
  testWidgets('LoginForm validates email and password', (WidgetTester tester) async {
    await tester.pumpWidget(MaterialApp(home: LoginForm()));
    
    // 测试空邮箱
    await tester.tap(find.text('Login'));
    await tester.pump();
    expect(find.text('Email is required'), findsOneWidget);
    
    // 输入无效邮箱
    await tester.enterText(find.byType(TextFormField).first, 'invalid');
    await tester.tap(find.text('Login'));
    await tester.pump();
    expect(find.text('Invalid email'), findsOneWidget);
    
    // 输入有效邮箱和密码
    await tester.enterText(find.byType(TextFormField).first, 'test@example.com');
    await tester.enterText(find.byType(TextFormField).last, 'password123');
    await tester.tap(find.text('Login'));
    await tester.pump();
    
    // 验证没有错误信息
    expect(find.text('Email is required'), findsNothing);
    expect(find.text('Invalid email'), findsNothing);
  });
}
```

### 测试状态管理

```dart
// 使用 Provider 测试
void main() {
  testWidgets('Counter increments with Provider', (WidgetTester tester) async {
    await tester.pumpWidget(
      ChangeNotifierProvider(
        create: (_) => CounterModel(),
        child: MaterialApp(
          home: CounterWidget(),
        ),
      ),
    );
    
    expect(find.text('Count: 0'), findsOneWidget);
    
    await tester.tap(find.text('Increment'));
    await tester.pump();
    
    expect(find.text('Count: 1'), findsOneWidget);
  });
}
```

## 测试覆盖率

```bash
# 生成测试覆盖率报告
flutter test --coverage

# 查看覆盖率（需要安装 lcov）
genhtml coverage/lcov.info -o coverage/html
open coverage/html/index.html
```

## 总结

- ✅ 单元测试测试单个函数或类
- ✅ Widget 测试测试 UI 组件
- ✅ 集成测试测试完整流程
- ✅ 使用 Mockito 进行 Mock 和 Stub
- ✅ 使用 find、tester、expect 进行测试操作
- ✅ 保持测试独立和可重复

下一步学习：[打包和发布](./13-打包和发布.md)

