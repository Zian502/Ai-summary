# 动画和交互

Flutter 提供了强大的动画系统和手势识别功能。本章介绍 Flutter 的动画实现和用户交互处理。

## 基础动画

### AnimationController（动画控制器）

AnimationController 是 Flutter 动画的核心，类似于 JavaScript 的 `requestAnimationFrame` 或 CSS 动画。

```dart
import 'package:flutter/material.dart';

class AnimatedWidget extends StatefulWidget {
  @override
  State<AnimatedWidget> createState() => _AnimatedWidgetState();
}

class _AnimatedWidgetState extends State<AnimatedWidget>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  
  @override
  void initState() {
    super.initState();
    // 创建动画控制器（持续时间 1 秒）
    _controller = AnimationController(
      vsync: this,
      duration: Duration(seconds: 1),
    );
  }
  
  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }
  
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        ElevatedButton(
          onPressed: () {
            // 播放动画
            _controller.forward();
            // _controller.reverse();  // 反向播放
            // _controller.repeat();    // 重复播放
          },
          child: Text('Animate'),
        ),
      ],
    );
  }
}

// 与 CSS 动画对比
// CSS:
//   @keyframes fadeIn {
//     from { opacity: 0; }
//     to { opacity: 1; }
//   }
//   animation: fadeIn 1s;
// Flutter:
//   AnimationController(duration: Duration(seconds: 1))
```

### Tween（补间动画）

Tween 定义动画的值范围，类似于 CSS 的 `from` 和 `to`。

```dart
class _AnimatedWidgetState extends State<AnimatedWidget>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;
  
  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: Duration(seconds: 1),
    );
    
    // 创建 Tween（从 0.0 到 1.0）
    _animation = Tween<double>(begin: 0.0, end: 1.0).animate(_controller);
    
    // 添加监听器
    _animation.addListener(() {
      setState(() {});  // 重建 Widget
    });
  }
  
  @override
  Widget build(BuildContext context) {
    return Opacity(
      opacity: _animation.value,  // 使用动画值
      child: Container(
        width: 200,
        height: 200,
        color: Colors.blue,
      ),
    );
  }
}

// 与 CSS 对比
// CSS: opacity: 0 → 1
// Flutter: Tween<double>(begin: 0.0, end: 1.0)
```

### Curve（动画曲线）

Curve 定义动画的缓动函数，类似于 CSS 的 `animation-timing-function`。

```dart
// 使用不同的曲线
_animation = Tween<double>(begin: 0.0, end: 1.0).animate(
  CurvedAnimation(
    parent: _controller,
    curve: Curves.easeInOut,  // 缓入缓出
    // curve: Curves.linear,     // 线性
    // curve: Curves.easeIn,     // 缓入
    // curve: Curves.easeOut,     // 缓出
    // curve: Curves.bounceOut,   // 弹跳
    // curve: Curves.elasticOut,  // 弹性
  ),
);

// 与 CSS 对比
// CSS: animation-timing-function: ease-in-out;
// Flutter: curve: Curves.easeInOut
```

## 内置动画 Widget

### AnimatedContainer

AnimatedContainer 自动在属性变化时播放动画，类似于 CSS 的 `transition`。

```dart
class AnimatedContainerExample extends StatefulWidget {
  @override
  State<AnimatedContainerExample> createState() => _AnimatedContainerExampleState();
}

class _AnimatedContainerExampleState extends State<AnimatedContainerExample> {
  bool _isExpanded = false;
  
  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: () {
        setState(() {
          _isExpanded = !_isExpanded;
        });
      },
      child: AnimatedContainer(
        duration: Duration(milliseconds: 300),
        curve: Curves.easeInOut,
        width: _isExpanded ? 300 : 100,
        height: _isExpanded ? 300 : 100,
        color: _isExpanded ? Colors.blue : Colors.red,
        child: Center(child: Text('Tap me')),
      ),
    );
  }
}

// 与 CSS 对比
// CSS:
//   .container {
//     width: 100px;
//     transition: width 0.3s ease-in-out;
//   }
//   .container.expanded { width: 300px; }
```

### AnimatedOpacity

AnimatedOpacity 自动在透明度变化时播放动画。

```dart
class AnimatedOpacityExample extends StatefulWidget {
  @override
  State<AnimatedOpacityExample> createState() => _AnimatedOpacityExampleState();
}

class _AnimatedOpacityExampleState extends State<AnimatedOpacityExample> {
  bool _visible = true;
  
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        AnimatedOpacity(
          opacity: _visible ? 1.0 : 0.0,
          duration: Duration(milliseconds: 500),
          child: Container(
            width: 200,
            height: 200,
            color: Colors.blue,
          ),
        ),
        ElevatedButton(
          onPressed: () {
            setState(() {
              _visible = !_visible;
            });
          },
          child: Text('Toggle'),
        ),
      ],
    );
  }
}
```

### AnimatedPositioned

AnimatedPositioned 自动在位置变化时播放动画。

```dart
class AnimatedPositionedExample extends StatefulWidget {
  @override
  State<AnimatedPositionedExample> createState() => _AnimatedPositionedExampleState();
}

class _AnimatedPositionedExampleState extends State<AnimatedPositionedExample> {
  bool _isRight = false;
  
  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        AnimatedPositioned(
          duration: Duration(milliseconds: 300),
          left: _isRight ? 200 : 0,
          top: 100,
          child: Container(
            width: 100,
            height: 100,
            color: Colors.blue,
          ),
        ),
        Positioned(
          bottom: 20,
          left: 0,
          right: 0,
          child: ElevatedButton(
            onPressed: () {
              setState(() {
                _isRight = !_isRight;
              });
            },
            child: Text('Move'),
          ),
        ),
      ],
    );
  }
}
```

### Hero（页面转场动画）

Hero 实现页面间的共享元素转场动画，类似于 Android 的共享元素转场。

```dart
// 第一个页面
class FirstPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: Hero(
          tag: 'avatar',  // 唯一标识
          child: GestureDetector(
            onTap: () {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (context) => SecondPage()),
              );
            },
            child: Container(
              width: 100,
              height: 100,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: Colors.blue,
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// 第二个页面
class SecondPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Detail')),
      body: Center(
        child: Hero(
          tag: 'avatar',  // 相同的 tag
          child: Container(
            width: 200,
            height: 200,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              color: Colors.blue,
            ),
          ),
        ),
      ),
    );
  }
}
```

## 手势识别

### GestureDetector（手势检测器）

GestureDetector 用于识别各种手势，类似于 JavaScript 的事件监听器。

```dart
GestureDetector(
  // 点击（类似于 onClick）
  onTap: () {
    print('Tapped');
  },
  
  // 双击
  onDoubleTap: () {
    print('Double tapped');
  },
  
  // 长按（类似于 onLongPress）
  onLongPress: () {
    print('Long pressed');
  },
  
  // 按下
  onTapDown: (TapDownDetails details) {
    print('Tap down at ${details.localPosition}');
  },
  
  // 抬起
  onTapUp: (TapUpDetails details) {
    print('Tap up');
  },
  
  // 取消
  onTapCancel: () {
    print('Tap cancelled');
  },
  
  child: Container(
    width: 200,
    height: 200,
    color: Colors.blue,
    child: Center(child: Text('Tap me')),
  ),
)

// 与 JavaScript 对比
// JavaScript:
//   element.addEventListener('click', () => { ... });
// Flutter:
//   GestureDetector(onTap: () { ... })
```

### 拖拽手势

```dart
class DraggableWidget extends StatefulWidget {
  @override
  State<DraggableWidget> createState() => _DraggableWidgetState();
}

class _DraggableWidgetState extends State<DraggableWidget> {
  Offset _position = Offset(100, 100);
  
  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      // 拖拽（类似于 onDrag）
      onPanUpdate: (DragUpdateDetails details) {
        setState(() {
          _position += details.delta;
        });
      },
      
      child: Stack(
        children: [
          Positioned(
            left: _position.dx,
            top: _position.dy,
            child: Container(
              width: 100,
              height: 100,
              color: Colors.blue,
              child: Center(child: Text('Drag me')),
            ),
          ),
        ],
      ),
    );
  }
}
```

### 缩放手势

```dart
class ScaleWidget extends StatefulWidget {
  @override
  State<ScaleWidget> createState() => _ScaleWidgetState();
}

class _ScaleWidgetState extends State<ScaleWidget> {
  double _scale = 1.0;
  
  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      // 缩放（类似于 pinch zoom）
      onScaleUpdate: (ScaleUpdateDetails details) {
        setState(() {
          _scale = details.scale;
        });
      },
      
      child: Transform.scale(
        scale: _scale,
        child: Container(
          width: 200,
          height: 200,
          color: Colors.blue,
          child: Center(child: Text('Pinch to zoom')),
        ),
      ),
    );
  }
}
```

### InkWell 和 InkResponse（Material 风格点击效果）

```dart
// InkWell 提供 Material Design 的涟漪效果
InkWell(
  onTap: () {
    print('Tapped');
  },
  child: Container(
    width: 200,
    height: 200,
    child: Center(child: Text('Tap me')),
  ),
)

// InkResponse 提供更精细的控制
InkResponse(
  onTap: () {
    print('Tapped');
  },
  splashColor: Colors.blue,
  highlightColor: Colors.blue.withOpacity(0.1),
  child: Container(
    width: 200,
    height: 200,
    child: Center(child: Text('Tap me')),
  ),
)
```

## 实际应用示例

### 淡入淡出动画

```dart
class FadeInWidget extends StatefulWidget {
  final Widget child;
  final Duration duration;
  
  const FadeInWidget({
    super.key,
    required this.child,
    this.duration = const Duration(milliseconds: 500),
  });
  
  @override
  State<FadeInWidget> createState() => _FadeInWidgetState();
}

class _FadeInWidgetState extends State<FadeInWidget>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;
  
  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: widget.duration,
    );
    _animation = Tween<double>(begin: 0.0, end: 1.0).animate(_controller);
    _controller.forward();
  }
  
  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }
  
  @override
  Widget build(BuildContext context) {
    return FadeTransition(
      opacity: _animation,
      child: widget.child,
    );
  }
}

// 使用
FadeInWidget(
  child: Text('Hello Flutter'),
)
```

### 滑动删除

```dart
class SwipeToDismissExample extends StatelessWidget {
  final List<String> items = List.generate(10, (i) => 'Item $i');
  
  @override
  Widget build(BuildContext context) {
    return ListView.builder(
      itemCount: items.length,
      itemBuilder: (context, index) {
        return Dismissible(
          key: Key(items[index]),
          background: Container(
            color: Colors.red,
            alignment: Alignment.centerRight,
            padding: EdgeInsets.only(right: 20),
            child: Icon(Icons.delete, color: Colors.white),
          ),
          direction: DismissDirection.endToStart,
          onDismissed: (direction) {
            // 删除项目
            items.removeAt(index);
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(content: Text('${items[index]} dismissed')),
            );
          },
          child: ListTile(
            title: Text(items[index]),
          ),
        );
      },
    );
  }
}
```

### 加载动画

```dart
class LoadingAnimation extends StatefulWidget {
  @override
  State<LoadingAnimation> createState() => _LoadingAnimationState();
}

class _LoadingAnimationState extends State<LoadingAnimation>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  
  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: Duration(seconds: 1),
    )..repeat();
  }
  
  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }
  
  @override
  Widget build(BuildContext context) {
    return RotationTransition(
      turns: _controller,
      child: Container(
        width: 50,
        height: 50,
        decoration: BoxDecoration(
          shape: BoxShape.circle,
          border: Border.all(color: Colors.blue, width: 3),
        ),
      ),
    );
  }
}
```

### 下拉刷新

```dart
class RefreshExample extends StatefulWidget {
  @override
  State<RefreshExample> createState() => _RefreshExampleState();
}

class _RefreshExampleState extends State<RefreshExample> {
  List<String> items = List.generate(5, (i) => 'Item $i');
  
  Future<void> _refresh() async {
    // 模拟网络请求
    await Future.delayed(Duration(seconds: 2));
    setState(() {
      items = List.generate(5, (i) => 'Refreshed Item $i');
    });
  }
  
  @override
  Widget build(BuildContext context) {
    return RefreshIndicator(
      onRefresh: _refresh,
      child: ListView.builder(
        itemCount: items.length,
        itemBuilder: (context, index) {
          return ListTile(title: Text(items[index]));
        },
      ),
    );
  }
}
```

## 总结

- ✅ 使用 `AnimationController` 和 `Tween` 创建自定义动画
- ✅ 使用内置动画 Widget（AnimatedContainer、AnimatedOpacity 等）简化动画
- ✅ 使用 `GestureDetector` 识别各种手势
- ✅ 使用 `Hero` 实现页面转场动画
- ✅ Flutter 的动画系统强大且灵活

下一步学习：[平台交互](./10-平台交互.md)

