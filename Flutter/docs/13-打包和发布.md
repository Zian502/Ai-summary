# 打包和发布

本章介绍如何将 Flutter 应用打包并发布到 Android 和 iOS 平台。

## Android 打包

### 配置应用信息

```yaml
# android/app/build.gradle
android {
    defaultConfig {
        applicationId "com.example.myapp"  // 应用 ID
        minSdkVersion 21                    // 最低 Android 版本
        targetSdkVersion 33                 // 目标 Android 版本
        versionCode 1                       // 版本号（整数）
        versionName "1.0.0"                 // 版本名称（字符串）
    }
}
```

```xml
<!-- android/app/src/main/AndroidManifest.xml -->
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <application
        android:label="My App"              <!-- 应用名称 -->
        android:icon="@mipmap/ic_launcher"> <!-- 应用图标 -->
        <!-- ... -->
    </application>
</manifest>
```

### 生成签名密钥

```bash
# 生成密钥库
keytool -genkey -v -keystore ~/upload-keystore.jks \
  -keyalg RSA -keysize 2048 -validity 10000 \
  -alias upload

# 会提示输入密码和相关信息
```

### 配置签名

```yaml
# android/key.properties
storePassword=your_store_password
keyPassword=your_key_password
keyAlias=upload
storeFile=/path/to/upload-keystore.jks
```

```gradle
// android/app/build.gradle
def keystoreProperties = new Properties()
def keystorePropertiesFile = rootProject.file('key.properties')
if (keystorePropertiesFile.exists()) {
    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}

android {
    signingConfigs {
        release {
            keyAlias keystoreProperties['keyAlias']
            keyPassword keystoreProperties['keyPassword']
            storeFile keystoreProperties['storeFile'] ? file(keystoreProperties['storeFile']) : null
            storePassword keystoreProperties['storePassword']
        }
    }
    buildTypes {
        release {
            signingConfig signingConfigs.release
        }
    }
}
```

### 构建 APK

```bash
# 构建 APK（用于直接安装）
flutter build apk

# 构建分体 APK（按架构分离，体积更小）
flutter build apk --split-per-abi

# 构建 App Bundle（用于 Google Play）
flutter build appbundle
```

### 构建产物位置

- APK: `build/app/outputs/flutter-apk/app-release.apk`
- App Bundle: `build/app/outputs/bundle/release/app-release.aab`

## iOS 打包

### 配置应用信息

```xml
<!-- ios/Runner/Info.plist -->
<key>CFBundleName</key>
<string>My App</string>
<key>CFBundleDisplayName</key>
<string>My App</string>
<key>CFBundleVersion</key>
<string>1</string>
<key>CFBundleShortVersionString</key>
<string>1.0.0</string>
```

### 配置签名

1. 在 Xcode 中打开 `ios/Runner.xcworkspace`
2. 选择 Runner target
3. 在 Signing & Capabilities 中配置：
   - Team: 选择你的开发团队
   - Bundle Identifier: 设置唯一标识符
   - Automatically manage signing: 勾选

### 构建 IPA

```bash
# 构建 iOS 应用
flutter build ios --release

# 在 Xcode 中归档和导出
# 1. Product > Archive
# 2. Distribute App
# 3. 选择分发方式（App Store、Ad Hoc、Enterprise）
```

### 使用命令行构建

```bash
# 构建 IPA（需要配置证书）
flutter build ipa

# 构建产物位置
# build/ios/ipa/your_app.ipa
```

## 环境配置

### 检查构建配置

```bash
# 检查 Flutter 环境
flutter doctor

# 检查构建配置
flutter build apk --debug    # Debug 模式
flutter build apk --profile   # Profile 模式（性能分析）
flutter build apk --release   # Release 模式（发布）
```

### 优化构建

```dart
// lib/main.dart
void main() {
  // Release 模式禁用调试功能
  if (kReleaseMode) {
    // 禁用日志
    debugPrint = (String? message, {int? wrapWidth}) {};
  }
  
  runApp(MyApp());
}
```

## 发布到应用商店

### Google Play

1. **准备材料**
   - 应用图标（512x512）
   - 应用截图（至少 2 张）
   - 应用描述
   - 隐私政策 URL（如需要）

2. **创建应用**
   - 登录 [Google Play Console](https://play.google.com/console)
   - 创建新应用
   - 填写应用信息

3. **上传 App Bundle**
   ```bash
   flutter build appbundle
   ```
   - 上传 `build/app/outputs/bundle/release/app-release.aab`

4. **填写商店信息**
   - 应用描述
   - 截图
   - 分类
   - 内容分级

5. **提交审核**

### Apple App Store

1. **准备材料**
   - 应用图标（1024x1024）
   - 应用截图（不同设备尺寸）
   - 应用描述
   - 隐私政策 URL（如需要）

2. **创建应用**
   - 登录 [App Store Connect](https://appstoreconnect.apple.com)
   - 创建新应用
   - 填写应用信息

3. **上传 IPA**
   ```bash
   flutter build ipa
   ```
   - 使用 Xcode 或 Transporter 上传

4. **填写商店信息**
   - 应用描述
   - 关键词
   - 截图
   - 分类

5. **提交审核**

## 版本管理

### 更新版本号

**Android:**
```yaml
# android/app/build.gradle
android {
    defaultConfig {
        versionCode 2        // 递增
        versionName "1.0.1"  // 更新版本名称
    }
}
```

**iOS:**
```xml
<!-- ios/Runner/Info.plist -->
<key>CFBundleVersion</key>
<string>2</string>
<key>CFBundleShortVersionString</key>
<string>1.0.1</string>
```

**Flutter:**
```yaml
# pubspec.yaml
version: 1.0.1+2  # versionName+versionCode
```

### 自动化版本管理

```dart
// lib/main.dart
import 'package:package_info_plus/package_info_plus.dart';

Future<void> showVersionInfo() async {
  final packageInfo = await PackageInfo.fromPlatform();
  print('App Name: ${packageInfo.appName}');
  print('Version: ${packageInfo.version}');
  print('Build Number: ${packageInfo.buildNumber}');
}
```

## 代码混淆（Android）

```gradle
// android/app/build.gradle
android {
    buildTypes {
        release {
            minifyEnabled true      // 启用代码混淆
            shrinkResources true     // 移除未使用的资源
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
}
```

```proguard
# android/app/proguard-rules.pro
# Flutter 相关规则
-keep class io.flutter.app.** { *; }
-keep class io.flutter.plugin.**  { *; }
-keep class io.flutter.util.**  { *; }
-keep class io.flutter.view.**  { *; }
-keep class io.flutter.**  { *; }
```

## 实际发布流程

### Android 发布清单

```bash
# 1. 更新版本号
# 编辑 android/app/build.gradle

# 2. 构建 App Bundle
flutter build appbundle

# 3. 测试构建产物
# 安装到设备测试

# 4. 上传到 Google Play Console
# 使用网页界面上传 app-release.aab

# 5. 填写商店信息并提交审核
```

### iOS 发布清单

```bash
# 1. 更新版本号
# 编辑 ios/Runner/Info.plist

# 2. 在 Xcode 中配置签名
# 打开 ios/Runner.xcworkspace

# 3. 构建 IPA
flutter build ipa

# 4. 使用 Xcode 归档
# Product > Archive

# 5. 上传到 App Store Connect
# 使用 Xcode Organizer 或 Transporter

# 6. 在 App Store Connect 中提交审核
```

## 持续集成（CI/CD）

### GitHub Actions 示例

```yaml
# .github/workflows/build.yml
name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
      - run: flutter pub get
      - run: flutter build appbundle
      - uses: actions/upload-artifact@v3
        with:
          name: app-release.aab
          path: build/app/outputs/bundle/release/app-release.aab

  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
      - run: flutter pub get
      - run: flutter build ipa
      - uses: actions/upload-artifact@v3
        with:
          name: app-release.ipa
          path: build/ios/ipa/*.ipa
```

## 总结

- ✅ Android 使用 App Bundle 格式发布到 Google Play
- ✅ iOS 使用 IPA 格式发布到 App Store
- ✅ 配置应用签名和证书
- ✅ 更新版本号并管理版本
- ✅ 使用 CI/CD 自动化构建和发布流程
- ✅ 遵循应用商店的审核指南

恭喜！你已经完成了 Flutter 从入门到进阶的学习！

