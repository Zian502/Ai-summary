# 性能优化

Flutter 应用性能优化的关键是减少不必要的重建、优化渲染和内存使用。本章介绍 Flutter 的性能优化技巧。

## Widget 重建优化

### const 构造函数

使用 `const` 构造函数可以避免不必要的重建，类似于 React 的 `React.memo`。

```dart
// ❌ 不好的做法：每次重建都会创建新实例
Widget build(BuildContext context) {
  return Column(
    children: [
      Text('Hello'),  // 每次重建都创建新实例
      Icon(Icons.star),
    ],
  );
}

// ✅ 好的做法：使用 const
Widget build(BuildContext context) {
  return Column(
    children: [
      const Text('Hello'),  // 编译时常量，不会重建
      const Icon(Icons.star),
    ],
  );
}

// 与 React 对比
// React:
//   const Hello = () => <div>Hello</div>;
//   export default React.memo(Hello);
// Flutter:
//   const Text('Hello')
```

### 提取 Widget

将复杂的 Widget 树拆分成小的 Widget，减少重建范围。

```dart
// ❌ 不好的做法：所有内容在一个 build 方法中
class MyWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // 大量子 Widget...
      ],
    );
  }
}

// ✅ 好的做法：提取成独立 Widget
class MyWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        HeaderWidget(),      // 独立 Widget
        ContentWidget(),      // 独立 Widget
        FooterWidget(),      // 独立 Widget
      ],
    );
  }
}

class HeaderWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Text('Header');
  }
}
```

### 使用 Builder 延迟构建

```dart
// 使用 Builder 延迟构建，避免不必要的重建
ListView.builder(
  itemCount: items.length,
  itemBuilder: (context, index) {
    return ListTile(
      title: Text(items[index]),
    );
  },
)

// 与 React 对比
// React:
//   {items.map((item, index) => <Item key={index} item={item} />)}
// Flutter:
//   ListView.builder(itemBuilder: (context, index) => Item(item: items[index]))
```

## 状态管理优化

### 使用 Selector 精确监听

```dart
// Provider 中使用 Selector 只监听需要的部分
Selector<CartModel, int>(
  selector: (_, cart) => cart.itemCount,  // 只监听 itemCount
  builder: (context, itemCount, child) {
    return Text('Items: $itemCount');
  },
)

// 与 React 对比
// React:
//   const itemCount = useSelector(state => state.cart.itemCount);
// Flutter:
//   Selector<CartModel, int>(selector: (_, cart) => cart.itemCount, ...)
```

### 避免在 build 中创建对象

```dart
// ❌ 不好的做法：每次 build 都创建新对象
Widget build(BuildContext context) {
  return Container(
    decoration: BoxDecoration(  // 每次重建都创建新对象
      color: Colors.blue,
    ),
  );
}

// ✅ 好的做法：提取为常量或类成员
class MyWidget extends StatelessWidget {
  static const _decoration = BoxDecoration(color: Colors.blue);
  
  @override
  Widget build(BuildContext context) {
    return Container(decoration: _decoration);
  }
}
```

## ListView 优化

### 使用 itemExtent

```dart
// 指定 item 高度，提升滚动性能
ListView.builder(
  itemCount: items.length,
  itemExtent: 50,  // 固定高度
  itemBuilder: (context, index) {
    return ListTile(title: Text(items[index]));
  },
)
```

### 使用 cacheExtent

```dart
// 控制缓存范围
ListView.builder(
  itemCount: items.length,
  cacheExtent: 500,  // 缓存 500 像素范围外的 item
  itemBuilder: (context, index) {
    return ListTile(title: Text(items[index]));
  },
)
```

### 使用 RepaintBoundary

```dart
// 隔离重绘区域
ListView.builder(
  itemCount: items.length,
  itemBuilder: (context, index) {
    return RepaintBoundary(  // 隔离重绘
      child: ListTile(title: Text(items[index])),
    );
  },
)
```

## 图片优化

### 使用合适的图片格式

```dart
// WebP 格式（Android）
// 使用 asset 图片时，优先使用 WebP
Image.asset('assets/images/logo.webp')

// 网络图片缓存
CachedNetworkImage(
  imageUrl: 'https://example.com/image.jpg',
  placeholder: (context, url) => CircularProgressIndicator(),
  errorWidget: (context, url, error) => Icon(Icons.error),
)
```

### 图片尺寸优化

```dart
// 使用合适的分辨率
Image.network(
  'https://example.com/image.jpg',
  width: 200,   // 指定宽度
  height: 200,   // 指定高度
  fit: BoxFit.cover,  // 裁剪模式
)
```

## 内存优化

### 及时释放资源

```dart
class MyWidget extends StatefulWidget {
  @override
  State<MyWidget> createState() => _MyWidgetState();
}

class _MyWidgetState extends State<MyWidget> {
  late AnimationController _controller;
  StreamSubscription? _subscription;
  
  @override
  void initState() {
    super.initState();
    _controller = AnimationController(vsync: this);
    _subscription = stream.listen((data) {});
  }
  
  @override
  void dispose() {
    // 释放资源
    _controller.dispose();
    _subscription?.cancel();
    super.dispose();
  }
}
```

### 使用 WeakReference（如果需要）

```dart
// 避免循环引用
class MyService {
  WeakReference<MyWidget>? _widgetRef;
  
  void setWidget(MyWidget widget) {
    _widgetRef = WeakReference(widget);
  }
}
```

## 构建优化

### 使用 const 构造函数

```dart
// 尽可能使用 const
const Text('Hello')
const Icon(Icons.star)
const SizedBox(height: 16)
```

### 避免在 build 中调用耗时操作

```dart
// ❌ 不好的做法：在 build 中调用耗时操作
Widget build(BuildContext context) {
  final data = expensiveComputation();  // 耗时操作
  return Text(data);
}

// ✅ 好的做法：在 initState 或使用 FutureBuilder
class MyWidget extends StatefulWidget {
  @override
  State<MyWidget> createState() => _MyWidgetState();
}

class _MyWidgetState extends State<MyWidget> {
  String? _data;
  
  @override
  void initState() {
    super.initState();
    _loadData();
  }
  
  Future<void> _loadData() async {
    final data = await expensiveComputation();
    setState(() {
      _data = data;
    });
  }
  
  @override
  Widget build(BuildContext context) {
    if (_data == null) {
      return CircularProgressIndicator();
    }
    return Text(_data!);
  }
}
```

## 性能分析工具

### Flutter DevTools

```bash
# 启动应用时启用性能分析
flutter run --profile

# 打开 DevTools
flutter pub global activate devtools
flutter pub global run devtools
```

### 性能覆盖层

```dart
// 在 MaterialApp 中启用性能覆盖层
MaterialApp(
  showPerformanceOverlay: true,  // 显示性能覆盖层
  // ...
)
```

### 时间线分析

```dart
import 'package:flutter/scheduler.dart';

// 记录时间线事件
Timeline.startSync('my_operation');
// 执行操作
Timeline.finishSync();
```

## 实际优化示例

### 优化列表性能

```dart
class OptimizedList extends StatelessWidget {
  final List<String> items;
  
  const OptimizedList({super.key, required this.items});
  
  @override
  Widget build(BuildContext context) {
    return ListView.builder(
      itemCount: items.length,
      itemExtent: 60,  // 固定高度
      cacheExtent: 500,  // 缓存范围
      itemBuilder: (context, index) {
        return RepaintBoundary(  // 隔离重绘
          child: ListTile(
            title: Text(items[index]),
          ),
        );
      },
    );
  }
}
```

### 优化图片加载

```dart
class OptimizedImage extends StatelessWidget {
  final String imageUrl;
  
  const OptimizedImage({super.key, required this.imageUrl});
  
  @override
  Widget build(BuildContext context) {
    return CachedNetworkImage(
      imageUrl: imageUrl,
      width: 200,
      height: 200,
      fit: BoxFit.cover,
      placeholder: (context, url) => Container(
        width: 200,
        height: 200,
        color: Colors.grey[300],
        child: Center(child: CircularProgressIndicator()),
      ),
      errorWidget: (context, url, error) => Container(
        width: 200,
        height: 200,
        color: Colors.grey[300],
        child: Icon(Icons.error),
      ),
    );
  }
}
```

### 优化状态管理

```dart
// 使用 Selector 精确监听
class CartItemCount extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Selector<CartModel, int>(
      selector: (_, cart) => cart.itemCount,
      builder: (context, itemCount, child) {
        return Badge(
          label: Text('$itemCount'),
          child: Icon(Icons.shopping_cart),
        );
      },
    );
  }
}
```

## 总结

- ✅ 使用 `const` 构造函数减少重建
- ✅ 提取 Widget 减少重建范围
- ✅ 使用 `ListView.builder` 优化列表性能
- ✅ 使用 `Selector` 精确监听状态
- ✅ 及时释放资源避免内存泄漏
- ✅ 使用性能分析工具定位问题

下一步学习：[测试](./12-测试.md)

