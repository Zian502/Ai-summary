# 路由和导航

Flutter 提供了强大的路由和导航系统，支持页面跳转、参数传递、路由守卫等功能。本章介绍 Flutter 的路由管理方式。

## 基础导航

### Navigator（导航器）

Navigator 是 Flutter 的导航管理器，类似于 React Router 或浏览器历史 API。

```dart
// 基本页面跳转（类似于 React Router 的 navigate）
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (context) => SecondPage(),
  ),
);

// 返回上一页（类似于 React Router 的 goBack 或浏览器 history.back()）
Navigator.pop(context);

// 返回并传递数据
Navigator.pop(context, 'Returned data');

// 接收返回的数据
final result = await Navigator.push(
  context,
  MaterialPageRoute(builder: (context) => SecondPage()),
);
print('Result: $result');

// 与 React Router 对比
// React Router:
//   navigate('/second-page')
//   navigate(-1)  // 返回
// Flutter:
//   Navigator.push(...)
//   Navigator.pop(...)
```

### 基本示例

```dart
// 首页
class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Home')),
      body: Center(
        child: ElevatedButton(
          onPressed: () {
            // 跳转到详情页
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) => DetailPage(),
              ),
            );
          },
          child: Text('Go to Detail'),
        ),
      ),
    );
  }
}

// 详情页
class DetailPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Detail')),
      body: Center(
        child: ElevatedButton(
          onPressed: () {
            // 返回上一页
            Navigator.pop(context);
          },
          child: Text('Go Back'),
        ),
      ),
    );
  }
}
```

## 命名路由

命名路由让路由管理更加清晰，类似于 React Router 的 Route 配置。

### 定义路由

```dart
void main() {
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      // 初始路由
      initialRoute: '/',
      
      // 路由表（类似于 React Router 的 routes 配置）
      routes: {
        '/': (context) => HomePage(),
        '/detail': (context) => DetailPage(),
        '/profile': (context) => ProfilePage(),
      },
      
      // 未知路由处理（类似于 React Router 的 404）
      onUnknownRoute: (settings) {
        return MaterialPageRoute(
          builder: (context) => NotFoundPage(),
        );
      },
    );
  }
}

// 使用命名路由
Navigator.pushNamed(context, '/detail');
Navigator.pushNamed(context, '/profile');

// 返回
Navigator.pop(context);

// 与 React Router 对比
// React Router:
//   <Route path="/" element={<HomePage />} />
//   <Route path="/detail" element={<DetailPage />} />
//   navigate('/detail')
// Flutter:
//   routes: { '/detail': (context) => DetailPage() }
//   Navigator.pushNamed(context, '/detail')
```

### 传递参数

```dart
// 方式 1: 通过 arguments 传递参数
Navigator.pushNamed(
  context,
  '/detail',
  arguments: {
    'id': 123,
    'name': 'Flutter',
  },
);

// 接收参数
class DetailPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final args = ModalRoute.of(context)!.settings.arguments as Map<String, dynamic>;
    final id = args['id'];
    final name = args['name'];
    
    return Scaffold(
      appBar: AppBar(title: Text('Detail')),
      body: Text('ID: $id, Name: $name'),
    );
  }
}

// 方式 2: 使用自定义路由生成器
MaterialApp(
  onGenerateRoute: (settings) {
    if (settings.name == '/detail') {
      final args = settings.arguments as Map<String, dynamic>;
      return MaterialPageRoute(
        builder: (context) => DetailPage(
          id: args['id'],
          name: args['name'],
        ),
      );
    }
    return null;
  },
)

// 与 React Router 对比
// React Router:
//   navigate('/detail', { state: { id: 123 } })
//   const { id } = useLocation().state
// Flutter:
//   Navigator.pushNamed(context, '/detail', arguments: {...})
//   final args = ModalRoute.of(context)!.settings.arguments
```

## 路由守卫

路由守卫用于在路由跳转前进行验证，类似于 React Router 的 `beforeEnter`。

### 使用 onGenerateRoute

```dart
class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      onGenerateRoute: (settings) {
        // 路由守卫：检查登录状态
        if (settings.name == '/profile' && !isLoggedIn()) {
          // 未登录，跳转到登录页
          return MaterialPageRoute(
            builder: (context) => LoginPage(),
          );
        }
        
        // 正常路由
        switch (settings.name) {
          case '/':
            return MaterialPageRoute(builder: (_) => HomePage());
          case '/profile':
            return MaterialPageRoute(builder: (_) => ProfilePage());
          default:
            return MaterialPageRoute(builder: (_) => NotFoundPage());
        }
      },
    );
  }
  
  bool isLoggedIn() {
    // 检查登录状态
    return false;
  }
}

// 与 React Router 对比
// React Router:
//   <Route path="/profile" element={<ProfilePage />} />
//   const navigate = useNavigate();
//   if (!isLoggedIn()) navigate('/login');
// Flutter:
//   在 onGenerateRoute 中检查登录状态
```

### 使用 WillPopScope（返回守卫）

```dart
// 阻止返回（类似于 React Router 的 Prompt）
class FormPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return WillPopScope(
      onWillPop: () async {
        // 显示确认对话框
        final shouldPop = await showDialog<bool>(
          context: context,
          builder: (context) => AlertDialog(
            title: Text('Confirm'),
            content: Text('Are you sure you want to go back?'),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(context, false),
                child: Text('Cancel'),
              ),
              TextButton(
                onPressed: () => Navigator.pop(context, true),
                child: Text('OK'),
              ),
            ],
          ),
        );
        return shouldPop ?? false;
      },
      child: Scaffold(
        appBar: AppBar(title: Text('Form')),
        body: TextField(),
      ),
    );
  }
}
```

## 路由动画

### 自定义路由动画

```dart
// 淡入淡出动画
Navigator.push(
  context,
  PageRouteBuilder(
    pageBuilder: (context, animation, secondaryAnimation) => DetailPage(),
    transitionsBuilder: (context, animation, secondaryAnimation, child) {
      return FadeTransition(
        opacity: animation,
        child: child,
      );
    },
    transitionDuration: Duration(milliseconds: 300),
  ),
);

// 滑动动画
Navigator.push(
  context,
  PageRouteBuilder(
    pageBuilder: (context, animation, secondaryAnimation) => DetailPage(),
    transitionsBuilder: (context, animation, secondaryAnimation, child) {
      const begin = Offset(1.0, 0.0);  // 从右侧滑入
      const end = Offset.zero;
      const curve = Curves.ease;
      
      var tween = Tween(begin: begin, end: end).chain(
        CurveTween(curve: curve),
      );
      
      return SlideTransition(
        position: animation.drive(tween),
        child: child,
      );
    },
  ),
);

// 缩放动画
Navigator.push(
  context,
  PageRouteBuilder(
    pageBuilder: (context, animation, secondaryAnimation) => DetailPage(),
    transitionsBuilder: (context, animation, secondaryAnimation, child) {
      return ScaleTransition(
        scale: animation,
        child: child,
      );
    },
  ),
);
```

## go_router（推荐的路由库）

go_router 是 Flutter 官方推荐的路由库，提供声明式路由和更好的类型安全。

### 安装 go_router

```yaml
# pubspec.yaml
dependencies:
  go_router: ^13.0.0
```

### 基本使用

```dart
import 'package:go_router/go_router.dart';

// 定义路由配置
final router = GoRouter(
  routes: [
    GoRoute(
      path: '/',
      builder: (context, state) => HomePage(),
    ),
    GoRoute(
      path: '/detail/:id',  // 路径参数
      builder: (context, state) {
        final id = state.pathParameters['id']!;
        return DetailPage(id: id);
      },
    ),
    GoRoute(
      path: '/profile',
      builder: (context, state) {
        final name = state.uri.queryParameters['name'];  // 查询参数
        return ProfilePage(name: name);
      },
    ),
  ],
);

// 在 MaterialApp 中使用
void main() {
  runApp(
    MaterialApp.router(
      routerConfig: router,
    ),
  );
}

// 导航
context.go('/detail/123');           // 跳转（替换当前路由）
context.push('/detail/123');         // 推入新路由
context.pop();                        // 返回
context.go('/profile?name=Flutter');  // 带查询参数

// 与 React Router v6 对比
// React Router:
//   <Route path="/detail/:id" element={<DetailPage />} />
//   navigate('/detail/123')
//   const { id } = useParams()
// go_router:
//   GoRoute(path: '/detail/:id', ...)
//   context.go('/detail/123')
//   state.pathParameters['id']
```

### 嵌套路由

```dart
final router = GoRouter(
  routes: [
    GoRoute(
      path: '/',
      builder: (context, state) => HomePage(),
      routes: [
        // 嵌套路由
        GoRoute(
          path: 'detail/:id',
          builder: (context, state) {
            final id = state.pathParameters['id']!;
            return DetailPage(id: id);
          },
        ),
      ],
    ),
  ],
);

// 使用 ShellRoute 实现嵌套布局
final router = GoRouter(
  routes: [
    ShellRoute(
      builder: (context, state, child) {
        return Scaffold(
          body: child,
          bottomNavigationBar: BottomNavigationBar(
            items: [
              BottomNavigationBarItem(icon: Icon(Icons.home), label: 'Home'),
              BottomNavigationBarItem(icon: Icon(Icons.profile), label: 'Profile'),
            ],
          ),
        );
      },
      routes: [
        GoRoute(path: '/', builder: (context, state) => HomePage()),
        GoRoute(path: '/profile', builder: (context, state) => ProfilePage()),
      ],
    ),
  ],
);
```

### 路由守卫

```dart
final router = GoRouter(
  redirect: (context, state) {
    // 全局路由守卫
    final isLoggedIn = checkLoginStatus();
    final isGoingToLogin = state.matchedLocation == '/login';
    
    if (!isLoggedIn && !isGoingToLogin) {
      return '/login';
    }
    
    if (isLoggedIn && isGoingToLogin) {
      return '/';
    }
    
    return null;  // 不重定向
  },
  routes: [
    GoRoute(
      path: '/login',
      builder: (context, state) => LoginPage(),
    ),
    GoRoute(
      path: '/profile',
      builder: (context, state) => ProfilePage(),
      redirect: (context, state) {
        // 单个路由守卫
        if (!checkLoginStatus()) {
          return '/login';
        }
        return null;
      },
    ),
  ],
);
```

## 实际应用示例

### Tab 导航

```dart
class MainPage extends StatefulWidget {
  @override
  State<MainPage> createState() => _MainPageState();
}

class _MainPageState extends State<MainPage> {
  int _currentIndex = 0;
  
  final List<Widget> _pages = [
    HomePage(),
    SearchPage(),
    ProfilePage(),
  ];
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: _pages[_currentIndex],
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: _currentIndex,
        onTap: (index) {
          setState(() {
            _currentIndex = index;
          });
        },
        items: [
          BottomNavigationBarItem(
            icon: Icon(Icons.home),
            label: 'Home',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.search),
            label: 'Search',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.person),
            label: 'Profile',
          ),
        ],
      ),
    );
  }
}
```

### Drawer 导航

```dart
class MainPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('My App')),
      drawer: Drawer(
        child: ListView(
          children: [
            DrawerHeader(
              child: Text('Menu'),
              decoration: BoxDecoration(color: Colors.blue),
            ),
            ListTile(
              leading: Icon(Icons.home),
              title: Text('Home'),
              onTap: () {
                Navigator.pop(context);
                Navigator.pushNamed(context, '/');
              },
            ),
            ListTile(
              leading: Icon(Icons.settings),
              title: Text('Settings'),
              onTap: () {
                Navigator.pop(context);
                Navigator.pushNamed(context, '/settings');
              },
            ),
            ListTile(
              leading: Icon(Icons.logout),
              title: Text('Logout'),
              onTap: () {
                Navigator.pop(context);
                // 处理登出逻辑
              },
            ),
          ],
        ),
      ),
      body: Center(child: Text('Main Content')),
    );
  }
}
```

### 路由传参与返回数据

```dart
// 发送页面
class ProductListPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Products')),
      body: ListView.builder(
        itemCount: products.length,
        itemBuilder: (context, index) {
          return ListTile(
            title: Text(products[index].name),
            onTap: () async {
              // 跳转并等待返回结果
              final result = await Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (context) => ProductDetailPage(
                    product: products[index],
                  ),
                ),
              );
              
              // 处理返回结果
              if (result == true) {
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(content: Text('Product updated')),
                );
              }
            },
          );
        },
      ),
    );
  }
}

// 接收页面
class ProductDetailPage extends StatelessWidget {
  final Product product;
  
  const ProductDetailPage({super.key, required this.product});
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text(product.name)),
      body: Column(
        children: [
          Text('Product: ${product.name}'),
          ElevatedButton(
            onPressed: () {
              // 返回并传递数据
              Navigator.pop(context, true);
            },
            child: Text('Save'),
          ),
        ],
      ),
    );
  }
}
```

## 总结

- ✅ 使用 `Navigator.push/pop` 进行基本导航
- ✅ 使用命名路由管理复杂路由结构
- ✅ 使用 `go_router` 获得更好的路由体验
- ✅ 实现路由守卫保护需要认证的页面
- ✅ 自定义路由动画提升用户体验

下一步学习：[网络请求](./07-网络请求.md)

