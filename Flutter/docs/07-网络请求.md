# 网络请求

Flutter 提供了多种方式进行网络请求，从基础的 `http` 包到功能强大的 `dio` 库。本章介绍 Flutter 的网络请求方式。

## http 包（官方基础包）

`http` 是 Flutter 官方提供的 HTTP 客户端，类似于 JavaScript 的 `fetch` API。

### 安装

```yaml
# pubspec.yaml
dependencies:
  http: ^1.1.0
```

```bash
flutter pub get
```

### 基本使用

```dart
import 'package:http/http.dart' as http;
import 'dart:convert';

// GET 请求（类似于 JavaScript fetch）
Future<void> fetchData() async {
  final response = await http.get(
    Uri.parse('https://api.example.com/users'),
  );
  
  if (response.statusCode == 200) {
    // 解析 JSON（类似于 JavaScript JSON.parse）
    final data = json.decode(response.body);
    print(data);
  } else {
    print('Error: ${response.statusCode}');
  }
}

// POST 请求
Future<void> postData() async {
  final response = await http.post(
    Uri.parse('https://api.example.com/users'),
    headers: {'Content-Type': 'application/json'},
    body: json.encode({
      'name': 'Flutter',
      'email': 'flutter@example.com',
    }),
  );
  
  if (response.statusCode == 201) {
    final data = json.decode(response.body);
    print(data);
  }
}

// PUT 请求
Future<void> updateData() async {
  final response = await http.put(
    Uri.parse('https://api.example.com/users/1'),
    headers: {'Content-Type': 'application/json'},
    body: json.encode({'name': 'Updated Name'}),
  );
}

// DELETE 请求
Future<void> deleteData() async {
  final response = await http.delete(
    Uri.parse('https://api.example.com/users/1'),
  );
}

// 与 JavaScript fetch 对比
// JavaScript:
//   fetch('https://api.example.com/users')
//     .then(res => res.json())
//     .then(data => console.log(data));
// Flutter:
//   final response = await http.get(Uri.parse('...'));
//   final data = json.decode(response.body);
```

### 带参数的请求

```dart
// 查询参数
final uri = Uri.parse('https://api.example.com/users')
    .replace(queryParameters: {
      'page': '1',
      'limit': '10',
    });
final response = await http.get(uri);

// 请求头
final response = await http.get(
  Uri.parse('https://api.example.com/users'),
  headers: {
    'Authorization': 'Bearer token123',
    'Content-Type': 'application/json',
  },
);

// 与 JavaScript 对比
// JavaScript:
//   fetch('https://api.example.com/users?page=1&limit=10', {
//     headers: { 'Authorization': 'Bearer token123' }
//   })
```

## dio（推荐）

`dio` 是一个功能强大的 HTTP 客户端，支持拦截器、请求取消、文件上传等功能，类似于 JavaScript 的 `axios`。

### 安装

```yaml
# pubspec.yaml
dependencies:
  dio: ^5.4.0
```

### 基本使用

```dart
import 'package:dio/dio.dart';

// 创建 Dio 实例
final dio = Dio();

// GET 请求
Future<void> fetchData() async {
  try {
    final response = await dio.get('https://api.example.com/users');
    print(response.data);  // 自动解析 JSON
  } on DioException catch (e) {
    print('Error: ${e.message}');
  }
}

// POST 请求
Future<void> postData() async {
  try {
    final response = await dio.post(
      'https://api.example.com/users',
      data: {
        'name': 'Flutter',
        'email': 'flutter@example.com',
      },
    );
    print(response.data);
  } on DioException catch (e) {
    print('Error: ${e.message}');
  }
}

// 查询参数
final response = await dio.get(
  'https://api.example.com/users',
  queryParameters: {'page': 1, 'limit': 10},
);

// 请求头
final response = await dio.get(
  'https://api.example.com/users',
  options: Options(
    headers: {'Authorization': 'Bearer token123'},
  ),
);

// 与 axios 对比
// JavaScript axios:
//   axios.get('https://api.example.com/users', {
//     params: { page: 1 },
//     headers: { Authorization: 'Bearer token123' }
//   })
// dio:
//   dio.get('https://api.example.com/users',
//     queryParameters: { page: 1 },
//     options: Options(headers: { 'Authorization': 'Bearer token123' })
//   )
```

### 配置 Dio

```dart
// 全局配置
final dio = Dio(BaseOptions(
  baseURL: 'https://api.example.com',
  connectTimeout: Duration(seconds: 5),
  receiveTimeout: Duration(seconds: 3),
  headers: {
    'Content-Type': 'application/json',
  },
));

// 使用配置的 baseURL
final response = await dio.get('/users');  // 实际请求: https://api.example.com/users

// 与 axios 对比
// JavaScript:
//   const axios = axios.create({
//     baseURL: 'https://api.example.com',
//     timeout: 5000,
//   });
```

### 拦截器

```dart
// 请求拦截器（类似于 axios 的 request interceptor）
dio.interceptors.add(InterceptorsWrapper(
  onRequest: (options, handler) {
    // 添加 token
    options.headers['Authorization'] = 'Bearer token123';
    return handler.next(options);
  },
  onResponse: (response, handler) {
    // 处理响应
    return handler.next(response);
  },
  onError: (error, handler) {
    // 处理错误
    if (error.response?.statusCode == 401) {
      // 处理未授权错误
    }
    return handler.next(error);
  },
));

// 日志拦截器
dio.interceptors.add(LogInterceptor(
  requestBody: true,
  responseBody: true,
));

// 与 axios 对比
// JavaScript:
//   axios.interceptors.request.use(config => {
//     config.headers.Authorization = 'Bearer token123';
//     return config;
//   });
```

### 错误处理

```dart
try {
  final response = await dio.get('/users');
} on DioException catch (e) {
  if (e.response != null) {
    // 服务器返回了错误响应
    print('Status: ${e.response?.statusCode}');
    print('Data: ${e.response?.data}');
  } else {
    // 请求失败（网络错误等）
    print('Error: ${e.message}');
  }
}
```

## JSON 序列化

### 手动序列化

```dart
// 定义模型类
class User {
  final int id;
  final String name;
  final String email;
  
  User({required this.id, required this.name, required this.email});
  
  // 从 JSON 创建对象（类似于 JavaScript 的对象解构）
  factory User.fromJson(Map<String, dynamic> json) {
    return User(
      id: json['id'],
      name: json['name'],
      email: json['email'],
    );
  }
  
  // 转换为 JSON（类似于 JavaScript 的 JSON.stringify）
  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'name': name,
      'email': email,
    };
  }
}

// 使用
final response = await dio.get('/users/1');
final user = User.fromJson(response.data);

// 发送数据
final user = User(id: 1, name: 'Flutter', email: 'flutter@example.com');
await dio.post('/users', data: user.toJson());
```

### json_serializable（自动序列化）

```yaml
# pubspec.yaml
dependencies:
  json_annotation: ^4.8.1

dev_dependencies:
  build_runner: ^2.4.7
  json_serializable: ^6.7.1
```

```dart
import 'package:json_annotation/json_annotation.dart';

part 'user.g.dart';

@JsonSerializable()
class User {
  final int id;
  final String name;
  final String email;
  
  User({required this.id, required this.name, required this.email});
  
  factory User.fromJson(Map<String, dynamic> json) => _$UserFromJson(json);
  Map<String, dynamic> toJson() => _$UserToJson(this);
}

// 生成代码
// flutter pub run build_runner build
```

## 实际应用示例

### API 服务类

```dart
class ApiService {
  final Dio _dio = Dio(BaseOptions(
    baseURL: 'https://api.example.com',
    connectTimeout: Duration(seconds: 5),
    receiveTimeout: Duration(seconds: 3),
  ));
  
  ApiService() {
    // 添加拦截器
    _dio.interceptors.add(InterceptorsWrapper(
      onRequest: (options, handler) {
        // 添加 token
        final token = getToken();
        if (token != null) {
          options.headers['Authorization'] = 'Bearer $token';
        }
        return handler.next(options);
      },
      onError: (error, handler) {
        if (error.response?.statusCode == 401) {
          // Token 过期，跳转到登录页
          // Navigator.pushNamed(context, '/login');
        }
        return handler.next(error);
      },
    ));
  }
  
  // GET 请求
  Future<List<User>> getUsers() async {
    try {
      final response = await _dio.get('/users');
      return (response.data as List)
          .map((json) => User.fromJson(json))
          .toList();
    } on DioException catch (e) {
      throw _handleError(e);
    }
  }
  
  // POST 请求
  Future<User> createUser(User user) async {
    try {
      final response = await dio.post('/users', data: user.toJson());
      return User.fromJson(response.data);
    } on DioException catch (e) {
      throw _handleError(e);
    }
  }
  
  // 错误处理
  String _handleError(DioException error) {
    if (error.response != null) {
      return 'Server error: ${error.response?.statusCode}';
    } else {
      return 'Network error: ${error.message}';
    }
  }
  
  String? getToken() {
    // 从存储中获取 token
    return null;
  }
}
```

### 在 Widget 中使用

```dart
class UserListPage extends StatefulWidget {
  @override
  State<UserListPage> createState() => _UserListPageState();
}

class _UserListPageState extends State<UserListPage> {
  final ApiService _apiService = ApiService();
  List<User> _users = [];
  bool _isLoading = true;
  String? _error;
  
  @override
  void initState() {
    super.initState();
    _loadUsers();
  }
  
  Future<void> _loadUsers() async {
    setState(() {
      _isLoading = true;
      _error = null;
    });
    
    try {
      final users = await _apiService.getUsers();
      setState(() {
        _users = users;
        _isLoading = false;
      });
    } catch (e) {
      setState(() {
        _error = e.toString();
        _isLoading = false;
      });
    }
  }
  
  @override
  Widget build(BuildContext context) {
    if (_isLoading) {
      return Center(child: CircularProgressIndicator());
    }
    
    if (_error != null) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text('Error: $_error'),
            ElevatedButton(
              onPressed: _loadUsers,
              child: Text('Retry'),
            ),
          ],
        ),
      );
    }
    
    return ListView.builder(
      itemCount: _users.length,
      itemBuilder: (context, index) {
        final user = _users[index];
        return ListTile(
          title: Text(user.name),
          subtitle: Text(user.email),
        );
      },
    );
  }
}
```

### 文件上传

```dart
// 上传文件（类似于 JavaScript FormData）
Future<void> uploadFile(String filePath) async {
  final formData = FormData.fromMap({
    'file': await MultipartFile.fromFile(filePath),
    'description': 'File description',
  });
  
  try {
    final response = await dio.post(
      '/upload',
      data: formData,
      onSendProgress: (sent, total) {
        // 上传进度
        final progress = sent / total;
        print('Progress: ${(progress * 100).toStringAsFixed(0)}%');
      },
    );
    print('Uploaded: ${response.data}');
  } on DioException catch (e) {
    print('Upload error: ${e.message}');
  }
}

// 与 JavaScript 对比
// JavaScript:
//   const formData = new FormData();
//   formData.append('file', file);
//   axios.post('/upload', formData, {
//     onUploadProgress: (progressEvent) => {
//       const progress = progressEvent.loaded / progressEvent.total;
//       console.log(`Progress: ${progress * 100}%`);
//     }
//   });
```

### 请求取消

```dart
// 取消请求（类似于 axios CancelToken）
final cancelToken = CancelToken();

// 发起请求
dio.get(
  '/users',
  cancelToken: cancelToken,
).then((response) {
  print(response.data);
}).catchError((e) {
  if (DioException.isCancelError(e)) {
    print('Request cancelled');
  }
});

// 取消请求
cancelToken.cancel('User cancelled');

// 与 axios 对比
// JavaScript:
//   const source = axios.CancelToken.source();
//   axios.get('/users', { cancelToken: source.token });
//   source.cancel('User cancelled');
```

## 总结

- ✅ `http` 包适合简单的 HTTP 请求
- ✅ `dio` 提供更多功能，推荐用于复杂应用
- ✅ 使用拦截器统一处理请求和响应
- ✅ 实现错误处理和重试机制
- ✅ 使用 JSON 序列化简化数据处理

下一步学习：[数据持久化](./08-数据持久化.md)

