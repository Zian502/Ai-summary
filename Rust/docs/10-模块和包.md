# 模块和包

Rust 的模块系统帮助你将代码组织成逻辑单元，并控制代码的可见性。理解模块系统对于编写可维护的 Rust 代码至关重要。

## 包（Packages）和 Crate

### Crate

Crate 是 Rust 的编译单元，可以是二进制文件或库。

- **二进制 crate**：可执行程序，必须有 `main` 函数
- **库 crate**：可被其他项目使用，没有 `main` 函数

### 包（Package）

包是一个或多个 crate 的集合，包含一个 `Cargo.toml` 文件。

```bash
# 创建二进制包
cargo new my-project

# 创建库包
cargo new --lib my-lib
```

### 包结构

```
my-project/
├── Cargo.toml
└── src/
    ├── main.rs          # 二进制 crate 的根
    └── lib.rs           # 库 crate 的根（如果存在）
```

## 模块（Modules）

模块让你可以将代码组织成逻辑单元，并控制可见性。

### 定义模块

```rust
// src/lib.rs
mod front_of_house {
    mod hosting {
        fn add_to_waitlist() {}
        fn seat_at_table() {}
    }
    
    mod serving {
        fn take_order() {}
        fn serve_order() {}
        fn take_payment() {}
    }
}
```

### 模块树

```
crate
 └── front_of_house
     ├── hosting
     │   ├── add_to_waitlist
     │   └── seat_at_table
     └── serving
         ├── take_order
         ├── serve_order
         └── take_payment
```

### 路径（Paths）

路径用于引用模块中的项。

#### 绝对路径

从 crate 根开始，以 crate 名称或字面量 `crate` 开头。

```rust
mod front_of_house {
    pub mod hosting {
        pub fn add_to_waitlist() {}
    }
}

pub fn eat_at_restaurant() {
    // 绝对路径
    crate::front_of_house::hosting::add_to_waitlist();
}
```

#### 相对路径

从当前模块开始，使用 `self`、`super` 或当前模块的标识符。

```rust
mod front_of_house {
    pub mod hosting {
        pub fn add_to_waitlist() {}
    }
    
    fn serve_order() {}
    
    mod back_of_house {
        fn fix_incorrect_order() {
            cook_order();
            super::serve_order();  // 使用 super 访问父模块
        }
        
        fn cook_order() {}
    }
}
```

### 使用 use 关键字

`use` 关键字将路径引入作用域。

```rust
mod front_of_house {
    pub mod hosting {
        pub fn add_to_waitlist() {}
    }
}

use crate::front_of_house::hosting;

pub fn eat_at_restaurant() {
    hosting::add_to_waitlist();  // 不需要完整路径
}
```

### 使用 use 的习惯用法

```rust
// 函数：引入父模块
use std::collections::HashMap;

fn main() {
    let mut map = HashMap::new();
}

// 结构体、枚举等：引入完整路径
use std::collections::HashMap;

// 同名类型：使用父模块区分
use std::fmt::Result;
use std::io::Result as IoResult;

// 使用 as 关键字重命名
use std::io::Result as IoResult;
```

### 使用 pub use 重新导出

```rust
mod front_of_house {
    pub mod hosting {
        pub fn add_to_waitlist() {}
    }
}

// 重新导出，使外部代码可以直接使用 hosting
pub use crate::front_of_house::hosting;

pub fn eat_at_restaurant() {
    hosting::add_to_waitlist();
}
```

### 使用外部包

在 `Cargo.toml` 中添加依赖：

```toml
[dependencies]
serde = "1.0"
tokio = { version = "1.0", features = ["full"] }
```

在代码中使用：

```rust
use serde::{Serialize, Deserialize};

#[derive(Serialize, Deserialize)]
struct User {
    name: String,
    age: u32,
}
```

## 模块文件系统

### 将模块拆分为文件

```
src/
├── main.rs
├── lib.rs
└── front_of_house.rs
```

```rust
// src/lib.rs
mod front_of_house;

pub use crate::front_of_house::hosting;

pub fn eat_at_restaurant() {
    hosting::add_to_waitlist();
}
```

```rust
// src/front_of_house.rs
pub mod hosting {
    pub fn add_to_waitlist() {}
}
```

### 将模块拆分为目录

```
src/
├── main.rs
├── lib.rs
└── front_of_house/
    ├── mod.rs
    └── hosting.rs
```

```rust
// src/front_of_house/mod.rs
pub mod hosting;
```

```rust
// src/front_of_house/hosting.rs
pub fn add_to_waitlist() {}
```

## 可见性

### pub 关键字

```rust
mod outer_module {
    pub mod inner_module {
        pub fn public_function() {
            println!("公共函数");
        }
        
        fn private_function() {
            println!("私有函数");
        }
    }
    
    fn outer_function() {
        inner_module::public_function();
        // inner_module::private_function();  // 错误！
    }
}

fn main() {
    outer_module::inner_module::public_function();
}
```

### pub 的不同级别

```rust
mod outer_module {
    pub mod inner_module {
        pub fn public_function() {}
        pub(self) fn module_function() {}  // 只在当前模块可见
        pub(super) fn parent_function() {}  // 在父模块可见
        pub(crate) fn crate_function() {}  // 在当前 crate 可见
    }
}
```

## 实践示例

### 示例 1：简单的库结构

```
my-lib/
├── Cargo.toml
└── src/
    ├── lib.rs
    ├── config.rs
    ├── user.rs
    └── utils/
        ├── mod.rs
        └── helpers.rs
```

```rust
// src/lib.rs
pub mod config;
pub mod user;
pub mod utils;

pub use config::Config;
pub use user::User;
```

```rust
// src/config.rs
pub struct Config {
    pub host: String,
    pub port: u16,
}

impl Config {
    pub fn new(host: String, port: u16) -> Self {
        Config { host, port }
    }
}
```

```rust
// src/user.rs
pub struct User {
    pub name: String,
    pub age: u32,
}

impl User {
    pub fn new(name: String, age: u32) -> Self {
        User { name, age }
    }
}
```

```rust
// src/utils/mod.rs
pub mod helpers;

pub fn public_util() {
    helpers::private_helper();
}
```

```rust
// src/utils/helpers.rs
pub(crate) fn private_helper() {
    println!("辅助函数");
}
```

### 示例 2：使用外部 crate

```toml
# Cargo.toml
[dependencies]
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
```

```rust
// src/main.rs
use serde::{Serialize, Deserialize};
use serde_json;

#[derive(Serialize, Deserialize, Debug)]
struct Person {
    name: String,
    age: u32,
}

fn main() {
    let person = Person {
        name: "Alice".to_string(),
        age: 30,
    };
    
    let json = serde_json::to_string(&person).unwrap();
    println!("{}", json);
}
```

### 示例 3：条件编译

```rust
// src/lib.rs
#[cfg(feature = "advanced")]
pub mod advanced;

pub mod basic;
```

```toml
# Cargo.toml
[features]
default = []
advanced = []
```

## 工作空间（Workspaces）

工作空间帮助管理多个相关的包。

```
my-workspace/
├── Cargo.toml
├── adder/
│   ├── Cargo.toml
│   └── src/
│       └── main.rs
└── add-one/
    ├── Cargo.toml
    └── src/
        └── lib.rs
```

```toml
# my-workspace/Cargo.toml
[workspace]
members = [
    "adder",
    "add-one",
]
```

```toml
# adder/Cargo.toml
[package]
name = "adder"
version = "0.1.0"

[dependencies]
add-one = { path = "../add-one" }
```

## 与其他语言对比

| 语言 | 模块系统 | 可见性控制 | 包管理 |
|------|---------|-----------|--------|
| **Rust** | `mod`、`use` | `pub` 关键字 | Cargo |
| **Python** | `import` | 命名约定 | pip |
| **Java** | `package`、`import` | `public/private` | Maven/Gradle |
| **Go** | `package` | 首字母大小写 | go mod |
| **Node.js** | `require`/`import` | 无内置 | npm |

**Rust 特点**：
- 显式的模块系统
- 编译时检查可见性
- 灵活的路径系统
- 强大的包管理工具（Cargo）

## 最佳实践

### 1. 使用清晰的模块结构

```
src/
├── lib.rs          # 库根
├── config.rs       # 配置
├── models/         # 数据模型
│   ├── mod.rs
│   └── user.rs
├── handlers/       # 请求处理
│   ├── mod.rs
│   └── api.rs
└── utils/          # 工具函数
    ├── mod.rs
    └── helpers.rs
```

### 2. 使用 pub use 重新导出

```rust
// src/lib.rs
mod internal {
    pub mod user {
        pub struct User {
            // ...
        }
    }
}

// 重新导出，简化外部 API
pub use internal::user::User;
```

### 3. 合理使用可见性

```rust
// 公共 API
pub fn public_function() {}

// 内部实现细节
pub(crate) fn internal_function() {}

// 模块私有
fn private_function() {}
```

## 总结

- **Crate**：编译单元（二进制或库）
- **包**：一个或多个 crate 的集合
- **模块**：代码组织单元，使用 `mod` 定义
- **路径**：引用模块中的项（绝对路径和相对路径）
- **use**：将路径引入作用域
- **pub**：控制可见性
- **文件系统**：模块可以映射到文件系统

继续学习：[泛型和特征](./11-泛型和特征.md) 学习 Rust 的泛型编程和 trait 系统！

