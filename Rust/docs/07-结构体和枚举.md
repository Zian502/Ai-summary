# 结构体和枚举

结构体（struct）和枚举（enum）是 Rust 中定义自定义类型的主要方式。它们让代码更加模块化和易于理解。

## 结构体（Structs）

结构体用于创建自定义数据类型，将相关的数据组合在一起。

### 定义和实例化

```rust
// 定义结构体
struct User {
    username: String,
    email: String,
    sign_in_count: u64,
    active: bool,
}

fn main() {
    // 创建结构体实例
    let user1 = User {
        email: String::from("someone@example.com"),
        username: String::from("someusername123"),
        active: true,
        sign_in_count: 1,
    };
    
    // 访问字段
    println!("用户名: {}", user1.username);
    println!("邮箱: {}", user1.email);
    
    // 修改字段（需要 mut）
    let mut user2 = User {
        email: String::from("another@example.com"),
        username: String::from("anotherusername567"),
        active: true,
        sign_in_count: 1,
    };
    user2.email = String::from("anotheremail@example.com");
    
    // 使用结构体更新语法
    let user3 = User {
        email: String::from("different@example.com"),
        username: String::from("differentusername"),
        ..user1  // 使用 user1 的剩余字段
    };
}
```

### 字段初始化简写

```rust
struct User {
    username: String,
    email: String,
    sign_in_count: u64,
    active: bool,
}

fn build_user(email: String, username: String) -> User {
    // 字段名和变量名相同时可以简写
    User {
        email,      // 等同于 email: email
        username,   // 等同于 username: username
        active: true,
        sign_in_count: 1,
    }
}

fn main() {
    let user = build_user(
        String::from("test@example.com"),
        String::from("testuser"),
    );
}
```

### 元组结构体（Tuple Structs）

元组结构体类似于元组，但有名称。

```rust
struct Color(i32, i32, i32);
struct Point(i32, i32, i32);

fn main() {
    let black = Color(0, 0, 0);
    let origin = Point(0, 0, 0);
    
    // 访问字段
    println!("黑色 RGB: ({}, {}, {})", black.0, black.1, black.2);
    
    // 注意：即使字段类型相同，Color 和 Point 也是不同的类型
    // let point: Point = black;  // 错误！
}
```

### 单元结构体（Unit-like Structs）

没有任何字段的结构体。

```rust
struct AlwaysEqual;

fn main() {
    let subject = AlwaysEqual;
    // 用于实现 trait 而不需要存储数据
}
```

### 结构体方法

使用 `impl` 块为结构体定义方法。

```rust
struct Rectangle {
    width: u32,
    height: u32,
}

impl Rectangle {
    // 关联函数（类似静态方法）
    fn new(width: u32, height: u32) -> Rectangle {
        Rectangle { width, height }
    }
    
    // 实例方法（第一个参数是 &self）
    fn area(&self) -> u32 {
        self.width * self.height
    }
    
    // 可变方法（第一个参数是 &mut self）
    fn set_width(&mut self, width: u32) {
        self.width = width;
    }
    
    // 获取所有权的方法（第一个参数是 self）
    fn into_tuple(self) -> (u32, u32) {
        (self.width, self.height)
    }
    
    // 方法可以调用其他方法
    fn can_hold(&self, other: &Rectangle) -> bool {
        self.width > other.width && self.height > other.height
    }
}

fn main() {
    let rect1 = Rectangle::new(30, 50);
    println!("面积: {}", rect1.area());
    
    let rect2 = Rectangle::new(10, 40);
    println!("rect1 能容纳 rect2: {}", rect1.can_hold(&rect2));
    
    let mut rect3 = Rectangle::new(20, 20);
    rect3.set_width(30);
}
```

### 多个 impl 块

可以为同一个结构体定义多个 `impl` 块。

```rust
struct Rectangle {
    width: u32,
    height: u32,
}

impl Rectangle {
    fn new(width: u32, height: u32) -> Rectangle {
        Rectangle { width, height }
    }
}

impl Rectangle {
    fn area(&self) -> u32 {
        self.width * self.height
    }
}
```

### 与其他语言对比

| 语言 | 结构体定义 | 方法定义 | 访问控制 |
|------|-----------|---------|---------|
| **Rust** | `struct Name { }` | `impl Name { }` | 模块级别 |
| **C++** | `struct Name { }` | 在结构体内 | `public/private` |
| **Go** | `type Name struct { }` | `func (r *Name) method() { }` | 首字母大小写 |
| **Java** | `class Name { }` | 在类内 | `public/private` |
| **Python** | `class Name:` | 在类内 | 命名约定 |

**Rust 特点**：
- 结构体只有数据，没有方法（方法在 `impl` 块中）
- 使用 `&self`、`&mut self`、`self` 区分方法类型
- 关联函数（类似静态方法）不使用 `self`

## 枚举（Enums）

枚举允许你定义一个类型，它可以是几个不同变体中的一个。

### 定义枚举

```rust
enum IpAddrKind {
    V4,
    V6,
}

fn main() {
    let four = IpAddrKind::V4;
    let six = IpAddrKind::V6;
    
    route(four);
    route(six);
}

fn route(ip_kind: IpAddrKind) {
    // 处理 ip_kind
}
```

### 将数据附加到枚举变体

```rust
enum IpAddr {
    V4(String),
    V6(String),
}

fn main() {
    let home = IpAddr::V4(String::from("127.0.0.1"));
    let loopback = IpAddr::V6(String::from("::1"));
}

// 更复杂的例子
enum IpAddr {
    V4(u8, u8, u8, u8),
    V6(String),
}

enum Message {
    Quit,  // 没有关联数据
    Move { x: i32, y: i32 },  // 匿名结构体
    Write(String),  // 单个 String
    ChangeColor(i32, i32, i32),  // 三个 i32
}
```

### 枚举方法

枚举也可以有方法。

```rust
enum Message {
    Quit,
    Move { x: i32, y: i32 },
    Write(String),
    ChangeColor(i32, i32, i32),
}

impl Message {
    fn call(&self) {
        // 方法体
    }
}

fn main() {
    let m = Message::Write(String::from("hello"));
    m.call();
}
```

### Option 枚举

`Option` 是 Rust 标准库中最重要的枚举之一，用于处理可能不存在的值。

```rust
// Option 的定义（简化版）
enum Option<T> {
    Some(T),
    None,
}

fn main() {
    let some_number = Some(5);
    let some_string = Some("a string");
    let absent_number: Option<i32> = None;
    
    // 使用 Option
    let x: i32 = 5;
    let y: Option<i32> = Some(5);
    
    // let sum = x + y;  // 错误！不能直接相加
    
    // 需要使用 match 或其他方法处理
    match y {
        Some(value) => println!("值: {}", value),
        None => println!("没有值"),
    }
}
```

### Result 枚举

`Result` 用于处理可能失败的操作。

```rust
// Result 的定义（简化版）
enum Result<T, E> {
    Ok(T),
    Err(E),
}

use std::fs::File;

fn main() {
    let f = File::open("hello.txt");
    
    match f {
        Ok(file) => println!("文件打开成功"),
        Err(error) => println!("文件打开失败: {:?}", error),
    }
}
```

### 与其他语言对比

| 语言 | 枚举定义 | 关联数据 | 模式匹配 |
|------|---------|---------|---------|
| **Rust** | `enum Name { }` | ✅ 支持 | ✅ 强大 |
| **C++** | `enum class Name { }` | ❌ 不支持 | ❌ 不支持 |
| **Go** | 使用常量 | ❌ 不支持 | ❌ 不支持 |
| **Java** | `enum Name { }` | ✅ 支持 | ❌ 有限 |
| **Swift** | `enum Name { }` | ✅ 支持 | ✅ 支持 |
| **Haskell** | `data Name = ...` | ✅ 支持 | ✅ 强大 |

**Rust 特点**：
- 枚举可以关联数据（类似联合体）
- 强大的模式匹配支持
- `Option` 和 `Result` 是标准库的核心

## 实践示例

### 示例 1：Web 服务器状态

```rust
enum StatusCode {
    Ok = 200,
    NotFound = 404,
    InternalServerError = 500,
}

struct Response {
    status: StatusCode,
    body: String,
}

impl Response {
    fn new(status: StatusCode, body: String) -> Response {
        Response { status, body }
    }
    
    fn send(&self) {
        println!("状态码: {}, 响应: {}", status as u16, self.body);
    }
}
```

### 示例 2：图形应用

```rust
enum Shape {
    Circle { radius: f64 },
    Rectangle { width: f64, height: f64 },
    Triangle { a: f64, b: f64, c: f64 },
}

impl Shape {
    fn area(&self) -> f64 {
        match self {
            Shape::Circle { radius } => std::f64::consts::PI * radius * radius,
            Shape::Rectangle { width, height } => width * height,
            Shape::Triangle { a, b, c } => {
                let s = (a + b + c) / 2.0;
                (s * (s - a) * (s - b) * (s - c)).sqrt()
            }
        }
    }
}

fn main() {
    let circle = Shape::Circle { radius: 5.0 };
    println!("圆的面积: {}", circle.area());
    
    let rect = Shape::Rectangle { width: 10.0, height: 20.0 };
    println!("矩形的面积: {}", rect.area());
}
```

### 示例 3：文件操作结果

```rust
use std::fs::File;
use std::io::Error;

enum FileOperation {
    Read { path: String },
    Write { path: String, content: String },
    Delete { path: String },
}

fn perform_operation(op: FileOperation) -> Result<String, Error> {
    match op {
        FileOperation::Read { path } => {
            std::fs::read_to_string(&path)
        }
        FileOperation::Write { path, content } => {
            std::fs::write(&path, content)?;
            Ok("写入成功".to_string())
        }
        FileOperation::Delete { path } => {
            std::fs::remove_file(&path)?;
            Ok("删除成功".to_string())
        }
    }
}
```

### 示例 4：状态机

```rust
enum State {
    Idle,
    Loading,
    Loaded { data: String },
    Error { message: String },
}

struct StateMachine {
    state: State,
}

impl StateMachine {
    fn new() -> StateMachine {
        StateMachine {
            state: State::Idle,
        }
    }
    
    fn start_loading(&mut self) {
        self.state = State::Loading;
    }
    
    fn finish_loading(&mut self, data: String) {
        self.state = State::Loaded { data };
    }
    
    fn set_error(&mut self, message: String) {
        self.state = State::Error { message };
    }
    
    fn get_data(&self) -> Option<&str> {
        match &self.state {
            State::Loaded { data } => Some(data),
            _ => None,
        }
    }
}
```

## 结构体和枚举的组合使用

```rust
struct User {
    username: String,
    email: String,
    role: UserRole,
    status: UserStatus,
}

enum UserRole {
    Admin,
    Moderator,
    User,
}

enum UserStatus {
    Active,
    Inactive,
    Banned { reason: String },
}

impl User {
    fn new(username: String, email: String, role: UserRole) -> User {
        User {
            username,
            email,
            role,
            status: UserStatus::Active,
        }
    }
    
    fn is_admin(&self) -> bool {
        matches!(self.role, UserRole::Admin)
    }
    
    fn ban(&mut self, reason: String) {
        self.status = UserStatus::Banned { reason };
    }
}
```

## 总结

- **结构体**：用于组合相关数据，可以有方法（通过 `impl` 块）
- **枚举**：用于表示可能的值之一，可以关联数据
- **方法**：使用 `impl` 块定义，`&self`、`&mut self`、`self` 区分方法类型
- **关联函数**：不使用 `self` 的函数，类似静态方法
- **Option 和 Result**：标准库中重要的枚举，用于处理可选值和错误

继续学习：[模式匹配](./08-模式匹配.md) 学习如何使用 match 处理枚举和结构体！

