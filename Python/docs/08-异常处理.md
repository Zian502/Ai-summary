# 异常处理

Python 使用异常来处理程序运行时出现的错误。

## 异常基础

### try-except 语句

```python
# 基本语法
try:
    # 可能出错的代码
    result = 10 / 0
except ZeroDivisionError:
    # 处理异常
    print("除数不能为0")

# 捕获多个异常
try:
    value = int("abc")
    result = 10 / value
except ValueError:
    print("无效的数字")
except ZeroDivisionError:
    print("除数不能为0")

# 捕获所有异常（不推荐，应该捕获具体异常）
try:
    risky_code()
except Exception as e:
    print(f"发生错误: {e}")
```

### try-except-else-finally

```python
try:
    # 可能出错的代码
    result = 10 / 2
except ZeroDivisionError:
    # 处理异常
    print("除数不能为0")
else:
    # 没有异常时执行
    print(f"结果: {result}")
finally:
    # 无论是否异常都会执行
    print("清理工作")

# 输出:
# 结果: 5.0
# 清理工作
```

## 常见异常类型

```python
# ValueError：值错误
try:
    int("abc")
except ValueError as e:
    print(f"值错误: {e}")

# TypeError：类型错误
try:
    "hello" + 5
except TypeError as e:
    print(f"类型错误: {e}")

# IndexError：索引错误
try:
    lst = [1, 2, 3]
    print(lst[10])
except IndexError as e:
    print(f"索引错误: {e}")

# KeyError：键错误
try:
    d = {"a": 1}
    print(d["b"])
except KeyError as e:
    print(f"键错误: {e}")

# FileNotFoundError：文件未找到
try:
    with open("nonexistent.txt") as f:
        content = f.read()
except FileNotFoundError as e:
    print(f"文件未找到: {e}")

# AttributeError：属性错误
try:
    obj = None
    obj.method()
except AttributeError as e:
    print(f"属性错误: {e}")
```

## 抛出异常

### raise 语句

```python
# 抛出异常
raise ValueError("这是一个错误消息")

# 重新抛出异常
try:
    risky_code()
except Exception as e:
    print(f"捕获到异常: {e}")
    raise  # 重新抛出

# 抛出不同类型的异常
raise TypeError("类型不匹配")
```

### 自定义异常

```python
# 定义自定义异常
class CustomError(Exception):
    """自定义异常基类"""
    pass

class ValidationError(CustomError):
    """验证错误"""
    def __init__(self, message, field=None):
        self.message = message
        self.field = field
        super().__init__(self.message)

# 使用自定义异常
def validate_age(age):
    if age < 0:
        raise ValidationError("年龄不能为负数", field="age")
    if age > 150:
        raise ValidationError("年龄不能超过150", field="age")
    return age

try:
    validate_age(-5)
except ValidationError as e:
    print(f"验证失败: {e.message}, 字段: {e.field}")
```

## 异常链

```python
try:
    risky_code()
except Exception as e:
    raise RuntimeError("新错误") from e  # 保留原始异常信息
```

## 实际应用场景 Demo

### Demo 1: 文件读取工具（带异常处理）

```python
#!/usr/bin/env python3
# file_reader.py - 文件读取工具

def read_file_safe(filename):
    """
    安全地读取文件
    
    参数:
        filename: 文件名
    
    返回:
        文件内容（字符串）或 None（如果出错）
    """
    try:
        with open(filename, 'r', encoding='utf-8') as f:
            return f.read()
    except FileNotFoundError:
        print(f"错误: 文件 '{filename}' 不存在")
        return None
    except PermissionError:
        print(f"错误: 没有权限读取文件 '{filename}'")
        return None
    except UnicodeDecodeError:
        print(f"错误: 文件 '{filename}' 编码错误")
        return None
    except Exception as e:
        print(f"未知错误: {e}")
        return None

def main():
    """主函数"""
    filename = input("请输入文件名: ")
    content = read_file_safe(filename)
    
    if content:
        print("\n文件内容:")
        print(content)
    else:
        print("无法读取文件")

if __name__ == "__main__":
    main()
```

### Demo 2: 数据验证工具

```python
#!/usr/bin/env python3
# validator.py - 数据验证工具

class ValidationError(Exception):
    """验证错误"""
    pass

class NumberValidator:
    """数字验证器"""
    
    @staticmethod
    def validate_positive(value):
        """验证正数"""
        if not isinstance(value, (int, float)):
            raise ValidationError(f"值必须是数字，得到: {type(value).__name__}")
        if value <= 0:
            raise ValidationError(f"值必须为正数，得到: {value}")
        return value
    
    @staticmethod
    def validate_range(value, min_val, max_val):
        """验证范围"""
        if not isinstance(value, (int, float)):
            raise ValidationError(f"值必须是数字")
        if value < min_val or value > max_val:
            raise ValidationError(f"值必须在 {min_val} 到 {max_val} 之间，得到: {value}")
        return value

def process_user_input():
    """处理用户输入"""
    try:
        age_str = input("请输入年龄: ")
        age = int(age_str)
        NumberValidator.validate_range(age, 0, 150)
        print(f"年龄验证通过: {age}")
        
        score_str = input("请输入分数 (0-100): ")
        score = float(score_str)
        NumberValidator.validate_range(score, 0, 100)
        print(f"分数验证通过: {score}")
        
    except ValueError:
        print("错误: 请输入有效的数字")
    except ValidationError as e:
        print(f"验证错误: {e}")
    except KeyboardInterrupt:
        print("\n操作被取消")
    except Exception as e:
        print(f"未知错误: {e}")

if __name__ == "__main__":
    process_user_input()
```

### Demo 3: 重试机制

```python
#!/usr/bin/env python3
# retry.py - 重试机制

import time
import random

def retry(max_attempts=3, delay=1, exceptions=(Exception,)):
    """
    重试装饰器
    
    参数:
        max_attempts: 最大尝试次数
        delay: 重试延迟（秒）
        exceptions: 要捕获的异常类型
    """
    def decorator(func):
        def wrapper(*args, **kwargs):
            for attempt in range(max_attempts):
                try:
                    return func(*args, **kwargs)
                except exceptions as e:
                    if attempt == max_attempts - 1:
                        raise
                    print(f"尝试 {attempt + 1} 失败: {e}，{delay} 秒后重试...")
                    time.sleep(delay)
            return None
        return wrapper
    return decorator

@retry(max_attempts=5, delay=0.5, exceptions=(ValueError,))
def unreliable_function():
    """可能失败的函数"""
    if random.random() < 0.7:
        raise ValueError("随机失败")
    return "成功"

def main():
    """主函数"""
    print("=" * 60)
    print("重试机制演示")
    print("=" * 60)
    
    for i in range(3):
        print(f"\n第 {i+1} 次调用:")
        try:
            result = unreliable_function()
            print(f"结果: {result}")
        except ValueError as e:
            print(f"最终失败: {e}")

if __name__ == "__main__":
    main()
```

## 异常处理最佳实践

1. **捕获具体异常**：不要使用裸露的 `except:`
2. **提供有意义的错误消息**
3. **使用 finally 进行清理**
4. **不要忽略异常**：至少记录日志
5. **自定义异常要有意义**

## 下一步

完成异常处理学习后，建议学习：
1. [文件操作](./09-文件操作.md) - 文件读写、路径处理
2. [高级特性](./10-高级特性.md) - 生成器、迭代器、上下文管理器

